# ECSæ¸²æŸ“å¼•æ“æ¶æ„æ–‡æ¡£

## å†™åœ¨å‰é¢
ä¹‹å‰å†™è¿‡ä¸€ç¯‡ECSæ–‡ç« ï¼Œä¸ºä»€ä¹ˆè¿˜è¦å†å†™ä¸€ä¸ªï¼Œæœ¬è´¨ä¸Šå› ä¸ºä¹‹å‰çš„æ–‡æ¡£ï¼Œæˆªæ­¢åˆ°ç›®å‰æ¥è¯´ï¼Œå˜åŒ–å·¨å¤§ï¼Œåº•å±‚å·²ç»æ”¹äº†å¾ˆå¤šå¾ˆå¤šï¼Œæ‰€ä»¥æœ‰å¿…è¦æŠŠä¸€äº›å†…å®¹æ‹å‡ºæ¥å•ç‹¬å»è¯´ã€‚

## é¡¹ç›®æ¦‚è§ˆ

Duck-Core æ˜¯ä¸€ä¸ªåŸºäº **ECSï¼ˆEntity-Component-Systemï¼‰æ¶æ„**æ„å»ºçš„é«˜æ€§èƒ½ Canvas æ¸²æŸ“å¼•æ“ï¼Œä¸“ä¸ºå¤æ‚å›¾å½¢ç¼–è¾‘åœºæ™¯è®¾è®¡ã€‚å¼•æ“çš„æ ¸å¿ƒç‰¹è‰²åœ¨äº**åŒæ¸²æŸ“åç«¯æ¶æ„**ã€**æ’ä»¶åŒ–ç³»ç»Ÿè®¾è®¡**å’Œ**æè‡´çš„æ¸²æŸ“æ€§èƒ½ä¼˜åŒ–**ã€‚

### æ ¸å¿ƒæŠ€æœ¯æ ˆ
- **CanvasKit-WASM** - Google Skia å›¾å½¢åº“çš„ WebAssembly ç§»æ¤ç‰ˆ
- **Canvas2D API** - æµè§ˆå™¨åŸç”Ÿæ¸²æŸ“æ¥å£

### æ¶æ„æ ¸å¿ƒäº®ç‚¹

**ECS æ¶æ„æ¨¡å¼** - æ•°æ®é©±åŠ¨çš„å®ä½“ç»„ä»¶ç³»ç»Ÿï¼Œå®ç°é€»è¾‘ä¸æ•°æ®å®Œå…¨è§£è€¦

**åŒå¼•æ“æ¶æ„** - Canvas2D ä¸ CanvasKit åŒæ¸²æŸ“åç«¯ï¼Œè¿è¡Œæ—¶æ— ç¼åˆ‡æ¢

ğŸ”Œ **æ’ä»¶åŒ–è®¾è®¡** - å¼€æ”¾å¼æ‰©å±•ç‚¹ï¼Œæ”¯æŒè‡ªå®šä¹‰æ¸²æŸ“å™¨ã€ç³»ç»Ÿå’Œç»„ä»¶

âš¡ **æè‡´æ€§èƒ½** - é¢œè‰²ç¼–ç æ‹¾å–ã€ç¦»å±æ¸²æŸ“ã€æ¸²æŸ“èŠ‚æµç­‰å¤šé‡ä¼˜åŒ–

---

## æ•´ä½“æ¶æ„è®¾è®¡

æ•´ä¸ªå¼•æ“é‡‡ç”¨åˆ†å±‚æ¶æ„ï¼Œä»åº•å±‚çš„æ¸²æŸ“æŠ½è±¡åˆ°é¡¶å±‚çš„ç”¨æˆ·äº¤äº’ï¼Œæ¯ä¸€å±‚èŒè´£æ¸…æ™°ä¸”å¯ç‹¬ç«‹æ›¿æ¢ã€‚

```mermaid
graph TB
    subgraph "åº”ç”¨å±‚"
        A[React ç»„ä»¶] --> B[Canvas ç”»å¸ƒç»„ä»¶]
    end
    
    subgraph "å¼•æ“æ ¸å¿ƒå±‚"
        B --> C[Engine å¼•æ“å®ä¾‹]
        C --> D[Core çŠ¶æ€ç®¡ç†å™¨]
        C --> E[Camera ç›¸æœºæ§åˆ¶]
        C --> F[Entity Manager å®ä½“ç®¡ç†]
    end
    
    subgraph "ç³»ç»Ÿå±‚ - System"
        C --> G[EventSystem äº‹ä»¶ç³»ç»Ÿ]
        G --> H[InputSystem è¾“å…¥ç³»ç»Ÿ]
        G --> I[RenderSystem æ¸²æŸ“ç³»ç»Ÿ]
        G --> J[PickingSystem æ‹¾å–ç³»ç»Ÿ]
        G --> K[DragSystem æ‹–æ‹½ç³»ç»Ÿ]
        G --> L[SelectionSystem é€‰æ‹©ç³»ç»Ÿ]
        G --> M[ZoomSystem ç¼©æ”¾ç³»ç»Ÿ]
        G --> M[FpsSystem FPS]
    end
    
    subgraph "æ¸²æŸ“å±‚ - Renderer"
        I --> N[RendererManager æ¸²æŸ“ç®¡ç†å™¨]
        N --> O{é€‰æ‹©æ¸²æŸ“åç«¯}
        O -->|Canvas2D| P[Canvas2D æ¸²æŸ“å™¨ç»„]
        O -->|CanvasKit| Q[CanvasKit æ¸²æŸ“å™¨ç»„]
        P --> R[RectRender]
        P --> S[EllipseRender]
        P --> T[TextRender]
        Q --> U[RectRender]
        Q --> V[EllipseRender]
        Q --> W[TextRender]
    end
    
    subgraph "æ•°æ®å±‚ - Component"
        X[StateStore çŠ¶æ€ä»“åº“]
        X --> Y[Position]
        X --> Z[Size]
        X --> AA[Color]
        X --> AB[Rotation]
        X --> AC[Selected]
    end
    
    D <--> X
    I --> X
    J --> X
    K --> X
    L --> X
    
    style C fill:#4A90E2,color:#fff
    style N fill:#E94B3C,color:#fff
    style X fill:#6ECB63,color:#fff
    style G fill:#F39C12,color:#fff
```

---

## ECS æ¶æ„æ·±åº¦è§£æ

### ä»€ä¹ˆæ˜¯ ECS æ¶æ„ï¼Ÿ

ECSï¼ˆEntity-Component-Systemï¼‰æ˜¯ä¸€ç§æºè‡ªæ¸¸æˆå¼•æ“çš„è®¾è®¡æ¨¡å¼ï¼Œå®ƒå½»åº•æ”¹å˜äº†ä¼ ç»Ÿé¢å‘å¯¹è±¡çš„ç»§æ‰¿ä½“ç³»ï¼Œè½¬è€Œé‡‡ç”¨**ç»„åˆä¼˜äºç»§æ‰¿**çš„ç†å¿µã€‚

**ä¸‰å¤§æ ¸å¿ƒæ¦‚å¿µï¼š**

1. **Entityï¼ˆå®ä½“ï¼‰** - ä»…æ˜¯ä¸€ä¸ªå”¯ä¸€ IDï¼Œä¸åŒ…å«ä»»ä½•æ•°æ®å’Œé€»è¾‘
2. **Componentï¼ˆç»„ä»¶ï¼‰** - çº¯æ•°æ®ç»“æ„ï¼Œæè¿°å®ä½“çš„å±æ€§ï¼ˆå¦‚ä½ç½®ã€é¢œè‰²ã€å¤§å°ï¼‰
3. **Systemï¼ˆç³»ç»Ÿï¼‰** - çº¯é€»è¾‘å¤„ç†å•å…ƒï¼Œæ“ä½œç‰¹å®šç»„ä»¶ç»„åˆçš„å®ä½“

```mermaid
graph TB
    subgraph "ä¼ ç»Ÿ OOP ç»§æ‰¿æ–¹å¼"
        A1[GameObject]
        A1 --> A2[Rectangle]
        A1 --> A3[Circle]
        A1 --> A4[Text]
        A2 --> A5[DraggableRectangle]
        A3 --> A6[SelectableCircle]
        style A1 fill:#ff9999
    end
    
    subgraph "ECS ç»„åˆæ–¹å¼"
        B1[Entity 123] -.æ‹¥æœ‰.-> B2[Position]
        B1 -.æ‹¥æœ‰.-> B3[Size]
        B1 -.æ‹¥æœ‰.-> B4[Color]
        
        B5[Entity 456] -.æ‹¥æœ‰.-> B6[Position]
        B5 -.æ‹¥æœ‰.-> B7[Font]
        B5 -.æ‹¥æœ‰.-> B8[Selected]
        
        B9[RenderSystem] --> B2 & B3 & B4
        B10[DragSystem] --> B2
        B11[SelectionSystem] --> B8
        
        style B1 fill:#99ccff
        style B5 fill:#99ccff
        style B9 fill:#99ff99
        style B10 fill:#99ff99
        style B11 fill:#99ff99
    end
```

### ECS æ¶æ„çš„æ ¸å¿ƒä¼˜åŠ¿

#### 1. æè‡´çš„è§£è€¦æ€§

ä¼ ç»Ÿ OOP ä¸­ï¼ŒåŠŸèƒ½é€šè¿‡ç»§æ‰¿é“¾ç´§å¯†è€¦åˆã€‚è€Œ ECS ä¸­ï¼Œç³»ç»Ÿåªä¾èµ–ç»„ä»¶æ¥å£ï¼Œå®ä½“çš„è¡Œä¸ºå®Œå…¨ç”±ç»„ä»¶ç»„åˆå†³å®šã€‚

```typescript
// âŒ ä¼ ç»Ÿæ–¹å¼ï¼šç´§è€¦åˆçš„ç»§æ‰¿é“¾
class Shape {
  render() { /* ... */ }
}
class DraggableShape extends Shape {
  drag() { /* ... */ }
}
class SelectableDraggableShape extends DraggableShape {
  select() { /* ... */ }
}

// âœ… ECS æ–¹å¼ï¼šç»„ä»¶è‡ªç”±ç»„åˆ
const rect = createEntity()
addComponent(rect, Position, { x: 100, y: 100 })
addComponent(rect, Size, { width: 200, height: 150 })
addComponent(rect, Draggable, {})  // å¯æ‹–æ‹½
addComponent(rect, Selected, {})   // å¯é€‰ä¸­
```

#### 2. å¼ºå¤§çš„å¯æ‰©å±•æ€§

æ–°å¢åŠŸèƒ½æ— éœ€ä¿®æ”¹ç°æœ‰ä»£ç ï¼Œåªéœ€æ·»åŠ æ–°çš„ç»„ä»¶å’Œç³»ç»Ÿï¼š

```mermaid
graph LR
    A[éœ€æ±‚ï¼šæ·»åŠ æ—‹è½¬åŠŸèƒ½] --> B[1. åˆ›å»º Rotation ç»„ä»¶]
    B --> C[2. åˆ›å»º RotationSystem]
    C --> D[3. ä¿®æ”¹ RenderSystem<br/>è¯»å– Rotation æ•°æ®]
    D --> E[å®Œæˆï¼æ— éœ€ä¿®æ”¹å…¶ä»–ä»£ç ]
    
    style A fill:#ffffcc
    style E fill:#ccffcc
```

#### 3. å¤©ç„¶çš„å¹¶è¡Œå¤„ç†èƒ½åŠ›

ç³»ç»Ÿä¹‹é—´æ— å…±äº«çŠ¶æ€ï¼Œå¯ä»¥å®‰å…¨åœ°å¹¶è¡Œæ‰§è¡Œï¼š

```typescript
// å¤šä¸ªç³»ç»Ÿå¯ä»¥åŒæ—¶è¯»å–åŒä¸€ä¸ªç»„ä»¶
async function updateFrame() {
  await Promise.all([
    physicsSystem.update(),   // è¯»å– Position
    renderSystem.update(),    // è¯»å– Position
    collisionSystem.update(), // è¯»å– Position
  ])
}
```

#### System ç³»ç»Ÿæ¶æ„

ç³»ç»Ÿè´Ÿè´£å¤„ç†é€»è¾‘ï¼Œé€šè¿‡æŸ¥è¯¢ StateStore è·å–éœ€è¦çš„ç»„ä»¶æ•°æ®ï¼š

```typescript
abstract class System {
  abstract update(stateStore: StateStore): void
}

class RenderSystem extends System {
  update(stateStore: StateStore) {
    // æŸ¥è¯¢æ‰€æœ‰æ‹¥æœ‰ Position ç»„ä»¶çš„å®ä½“
    for (const [entityId, position] of stateStore.position) {
      const size = stateStore.size.get(entityId)
      const color = stateStore.color.get(entityId)
      const type = stateStore.type.get(entityId)
      
      // æ ¹æ®ç±»å‹è°ƒç”¨å¯¹åº”çš„æ¸²æŸ“å™¨
      this.renderMap.get(type)?.draw(entityId)
    }
  }
}
```

**ç³»ç»Ÿå®Œæ•´åˆ—è¡¨ï¼š**

```mermaid
graph TB
    A[EventSystem<br/>äº‹ä»¶æ€»çº¿] --> B[InputSystem<br/>è¾“å…¥æ•è·]
    A --> C[HoverSystem<br/>æ‚¬åœæ£€æµ‹]
    A --> D[ClickSystem<br/>ç‚¹å‡»å¤„ç†]
    A --> E[DragSystem<br/>æ‹–æ‹½é€»è¾‘]
    A --> F[SelectionSystem<br/>é€‰æ‹©ç®¡ç†]
    A --> G[ZoomSystem<br/>ç¼©æ”¾æ§åˆ¶]
    A --> H[ScrollSystem<br/>æ»šåŠ¨å¹³ç§»]
    A --> I[PickingSystem<br/>å›¾å½¢æ‹¾å–]
    A --> J[RenderSystem<br/>æ¸²æŸ“ç»˜åˆ¶]
    A --> K[FpsSystem<br/>æ€§èƒ½ç›‘æ§]
    
    style A fill:#F39C12,color:#fff
    style J fill:#E74C3C,color:#fff
    style I fill:#3498DB,color:#fff
```

## åŒå¼•æ“æ¶æ„è®¾è®¡

### æ¶æ„è®¾è®¡ç†å¿µ

ä¸åŒçš„åº”ç”¨åœºæ™¯å¯¹æ¸²æŸ“å¼•æ“æœ‰ä¸åŒçš„éœ€æ±‚ï¼š

- **ç®€å•åœºæ™¯**ï¼šéœ€è¦å¿«é€Ÿå¯åŠ¨ã€ä½“ç§¯å°ã€å…¼å®¹æ€§å¥½
- **å¤æ‚åœºæ™¯**ï¼šéœ€è¦é«˜æ€§èƒ½ã€ä¸°å¯Œç‰¹æ•ˆã€å¤§é‡å›¾å½¢

ä¼ ç»Ÿæ–¹æ¡ˆé€šå¸¸åªæ”¯æŒå•ä¸€æ¸²æŸ“åç«¯ï¼Œéš¾ä»¥å…¼é¡¾ä¸¤è€…ã€‚æœ¬å¼•æ“é‡‡ç”¨**åŒå¼•æ“å¯åˆ‡æ¢æ¶æ„**ï¼Œåœ¨è¿è¡Œæ—¶åŠ¨æ€é€‰æ‹©æœ€ä¼˜æ¸²æŸ“åç«¯ã€‚

```mermaid
graph TB
    A[åº”ç”¨å¯åŠ¨] --> B{æ£€æµ‹åœºæ™¯å¤æ‚åº¦}
    B -->|ç®€å•åœºæ™¯<br/>< 100 å›¾å½¢| C[Canvas2D å¼•æ“]
    B -->|å¤æ‚åœºæ™¯<br/>> 100 å›¾å½¢| D[CanvasKit å¼•æ“]
    B -->|ç”¨æˆ·æ‰‹åŠ¨æŒ‡å®š| E[ç”¨æˆ·é€‰æ‹©]
    
    C --> F[æµè§ˆå™¨åŸç”Ÿ API]
    D --> G[Skia WASM å¼•æ“]
    
    C --> H[æ¸²æŸ“è¾“å‡º]
    D --> H
    
    I[è¿è¡Œæ—¶åˆ‡æ¢] -.->|çƒ­åˆ‡æ¢| C
    I -.->|çƒ­åˆ‡æ¢| D
    
    style C fill:#90EE90
    style D fill:#87CEEB
    style H fill:#FFD700
```

### æ¸²æŸ“åç«¯å¯¹æ¯”

| ç‰¹æ€§ | Canvas2D | CanvasKit (Skia) |
|-----|----------|------------------|
| **å¯åŠ¨é€Ÿåº¦** | âš¡ï¸ å³æ—¶ï¼ˆ0msï¼‰ | ğŸ¢ éœ€åŠ è½½ WASMï¼ˆ~2sï¼‰ |
| **åŒ…ä½“ç§¯** | âœ… 0 KB | âš ï¸ ~1.5 MB |
| **æµè§ˆå™¨å…¼å®¹æ€§** | âœ… 100% | âš ï¸ éœ€æ”¯æŒ WASM |
| **æ¸²æŸ“æ€§èƒ½** | ğŸŸ¡ ä¸­ç­‰ | ğŸŸ¢ ä¼˜ç§€ |
| **å¤æ‚è·¯å¾„æ¸²æŸ“** | ğŸŸ¡ ä¸€èˆ¬ | ğŸŸ¢ ä¼˜ç§€ |
| **æ–‡å­—æ¸²æŸ“** | ğŸŸ¡ è´¨é‡ä¸€èˆ¬ | ğŸŸ¢ äºšåƒç´ çº§ |
| **æ»¤é•œç‰¹æ•ˆ** | âŒ æœ‰é™ | âœ… ä¸°å¯Œ |
| **ç¦»å±æ¸²æŸ“** | âœ… æ”¯æŒ | âœ… æ”¯æŒ |
| **æœ€ä½³åœºæ™¯** | ç®€å•å›¾å½¢ã€å¿«é€ŸåŸå‹ | å¤æ‚è®¾è®¡ã€é«˜æ€§èƒ½éœ€æ±‚ |

### RendererManager æ¸²æŸ“ç®¡ç†å™¨

`RendererManager` æ˜¯åŒå¼•æ“æ¶æ„çš„æ ¸å¿ƒæ¢çº½ï¼Œè´Ÿè´£æ¸²æŸ“å™¨çš„æ³¨å†Œã€åˆ‡æ¢å’Œè°ƒåº¦ï¼š

```typescript
class RendererManager {
  rendererName: 'Canvas2D' | 'Canvaskit' = 'Canvaskit'
  
  // æ¸²æŸ“å™¨æ˜ å°„è¡¨
  renderer: {
    rect: typeof RectRender
    ellipse: typeof EllipseRender
    text: typeof TextRender
    img: typeof ImgRender
    polygon: typeof PolygonRender
  }
  
  // åˆ‡æ¢æ¸²æŸ“åç«¯
  setRenderer(name: 'Canvas2D' | 'Canvaskit') {
    this.rendererName = name
    
    if (name === 'Canvas2D') {
      this.renderer = Canvas2DRenderers
    } else {
      this.renderer = CanvaskitRenderers
    }
  }
}
```

**æ¸²æŸ“å™¨åˆ‡æ¢æµç¨‹ï¼š**

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·æ“ä½œ
    participant E as Engine
    participant RM as RendererManager
    participant RS as RenderSystem
    participant R1 as Canvas2D Renderer
    participant R2 as CanvasKit Renderer
    
    U->>E: setRenderer('Canvas2D')
    E->>RM: setRenderer('Canvas2D')
    RM->>RM: åŠ è½½ Canvas2D æ¸²æŸ“å™¨ç»„
    RM-->>E: åˆ‡æ¢å®Œæˆ
    
    E->>RS: è§¦å‘é‡æ–°æ¸²æŸ“
    RS->>RM: è·å– rect æ¸²æŸ“å™¨
    RM-->>RS: è¿”å› Canvas2D.RectRender
    RS->>R1: è°ƒç”¨ draw() æ–¹æ³•
    R1->>R1: ä½¿ç”¨ ctx.fillRect()
    
    Note over U,R2: ç”¨æˆ·å†æ¬¡åˆ‡æ¢å¼•æ“
    
    U->>E: setRenderer('Canvaskit')
    E->>RM: setRenderer('Canvaskit')
    RM->>RM: åŠ è½½ CanvasKit æ¸²æŸ“å™¨ç»„
    RM-->>E: åˆ‡æ¢å®Œæˆ
    
    E->>RS: è§¦å‘é‡æ–°æ¸²æŸ“
    RS->>RM: è·å– rect æ¸²æŸ“å™¨
    RM-->>RS: è¿”å› CanvasKit.RectRender
    RS->>R2: è°ƒç”¨ draw() æ–¹æ³•
    R2->>R2: ä½¿ç”¨ canvas.drawRect()
```

### æ¸²æŸ“å™¨ç»Ÿä¸€æ¥å£

æ‰€æœ‰æ¸²æŸ“å™¨å®ç°ç›¸åŒçš„æ¥å£ï¼Œä¿è¯å¯æ›¿æ¢æ€§ï¼š

```typescript
abstract class BaseRenderer extends System {
  constructor(protected engine: Engine) {
    super()
  }
  
  // ç»Ÿä¸€çš„æ¸²æŸ“æ¥å£
  abstract draw(entityId: string): void
  
}
```

### è‡ªå®šä¹‰æ¸²æŸ“å™¨æ‰©å±•

å¼•æ“æ”¯æŒç”¨æˆ·è‡ªå®šä¹‰æ¸²æŸ“å™¨ï¼Œåªéœ€å®ç° `System` æ¥å£ï¼š

```typescript
// 1. åˆ›å»ºè‡ªå®šä¹‰æ¸²æŸ“å™¨
class CustomStarRender extends System {
  draw(entityId: string) {
    const points = this.getComponent<Polygon>(entityId, 'polygon')
    const color = this.getComponent<Color>(entityId, 'color')
    
    // è‡ªå®šä¹‰ç»˜åˆ¶é€»è¾‘
    const ctx = this.engine.ctx
    ctx.beginPath()
    points.points.forEach((p, i) => {
      i === 0 ? ctx.moveTo(p.x, p.y) : ctx.lineTo(p.x, p.y)
    })
    ctx.closePath()
    ctx.fillStyle = color.fill
    ctx.fill()
  }
}
const customRenderMap = {
  star: CustomStarRender
}
// 2. æ³¨å†Œåˆ°å¼•æ“
new RendererRegistry().register({
  "custom": customRenderMap
})


```

### å­—ä½“æ¸²æŸ“ä¼˜åŒ–

CanvasKit éœ€è¦é¢„åŠ è½½å­—ä½“æ–‡ä»¶ï¼Œå¼•æ“å®ç°äº†å­—ä½“ç®¡ç†å™¨ï¼š

```typescript
async function loadFonts(CanvasKit: any) {
  const fontsBase = import.meta.env?.MODE === 'production' 
    ? '/design/fonts/' 
    : '/fonts/'

  const [robotoFont, notoSansFont] = await Promise.all([
    fetch(`${fontsBase}Roboto-Regular.ttf`).then(r => r.arrayBuffer()),
    fetch(`${fontsBase}NotoSansSC-VariableFont_wght_2.ttf`).then(r => r.arrayBuffer()),
  ])

  const fontMgr = CanvasKit.FontMgr.FromData(robotoFont, notoSansFont)
  return fontMgr
}

// åœ¨ CanvasKit åˆå§‹åŒ–æ—¶è°ƒç”¨
export async function createCanvasKit() {
  const CanvasKit = await initCanvasKit()
  const FontMgr = await loadFonts(CanvasKit)
  return { CanvasKit, FontMgr }
}
```

### å¼•æ“å·¥å‚æ¨¡å¼

ä½¿ç”¨å·¥å‚å‡½æ•°åˆ›å»ºä¸åŒé…ç½®çš„å¼•æ“å®ä¾‹ï¼š

```typescript
export function createCanvasRenderer(engine: Engine) {
  // Canvas2D å¼•æ“åˆ›å»ºå™¨
  const createCanvas2D = (config: DefaultConfig) => {
    const canvas = document.createElement('canvas')
    const dpr = window.devicePixelRatio || 1
    canvas.style.width = config.width + 'px'
    canvas.style.height = config.height + 'px'
    canvas.width = config.width * dpr
    canvas.height = config.height * dpr
    
    const ctx = canvas.getContext('2d', {
      willReadFrequently: true,
    }) as CanvasRenderingContext2D
    ctx.scale(dpr, dpr)
    
    config.container.appendChild(canvas)
    
    return { canvasDom: canvas, canvas: ctx, ctx }
  }

  // CanvasKit å¼•æ“åˆ›å»ºå™¨
  const createCanvasKitSkia = async (config: DefaultConfig) => {
    const { CanvasKit, FontMgr } = await createCanvasKit()
    const canvasDom = document.createElement('canvas')
    const dpr = window.devicePixelRatio || 1
    
    canvasDom.style.width = config.width + 'px'
    canvasDom.style.height = config.height + 'px'
    canvasDom.width = config.width * dpr
    canvasDom.height = config.height * dpr
    canvasDom.id = 'canvasKitCanvas'
    
    config.container.appendChild(canvasDom)
    
    const surface = CanvasKit.MakeWebGLCanvasSurface('canvasKitCanvas')
    const canvas = surface!.getCanvas()
    
    return {
      canvasDom,
      surface,
      canvas: canvas,
      FontMgr: FontMgr,
      ck: CanvasKit,
    }
  }

  return {
    createCanvas2D,
    createCanvasKitSkia,
  }
}
```

### Engine å¼•æ“æ ¸å¿ƒ

`Engine` ç±»æ˜¯æ•´ä¸ªæ¸²æŸ“ç³»ç»Ÿçš„ä¸­æ¢ï¼Œåè°ƒæ‰€æœ‰å­ç³»ç»Ÿçš„è¿è¡Œï¼š

```typescript
class Engine implements EngineContext {
  camera: Camera = new Camera()
  entityManager: Entity = new Entity()
  SystemMap: Map<string, System> = new Map()
  rendererManager: RendererManager = new RendererManager()
  
  canvas!: Canvas  // æ¸²æŸ“ç”»å¸ƒï¼ˆç±»å‹å–å†³äºæ¸²æŸ“åç«¯ï¼‰
  ctx!: CanvasRenderingContext2D
  ck!: CanvasKit
  
  constructor(public core: Core, rendererName?: string) {
    // åˆå§‹åŒ–æ¸²æŸ“å™¨
    this.rendererManager.rendererName = rendererName || 'Canvaskit'
    this.rendererManager.setRenderer(this.rendererManager.rendererName)
  }
  
  // æ·»åŠ ç³»ç»Ÿ
  addSystem(system: System) {
    this.system.push(system)
    this.SystemMap.set(system.constructor.name, system)
  }
  
  // è·å–ç³»ç»Ÿ
  getSystemByName<T extends System>(name: string): T | undefined {
    return this.SystemMap.get(name) as T
  }
  
  // æ¸…ç©ºç”»å¸ƒï¼ˆé€‚é…åŒå¼•æ“ï¼‰
  clear() {
    const canvas = this.canvas as any
    if (canvas?.clearRect) {
      // Canvas2D æ¸…ç©ºæ–¹å¼
      canvas.clearRect(0, 0, this.defaultSize.width, this.defaultSize.height)
    } else {
      // CanvasKit æ¸…ç©ºæ–¹å¼
      this.canvas.clear(this.ck.WHITE)
    }
  }
}
```

---

## æ’ä»¶åŒ–ç³»ç»Ÿè®¾è®¡

### ç³»ç»Ÿå³æ’ä»¶

å¼•æ“çš„æ‰€æœ‰åŠŸèƒ½éƒ½ä»¥ System å½¢å¼å®ç°ï¼Œæ¯ä¸ª System éƒ½æ˜¯ç‹¬ç«‹çš„æ’ä»¶ã€‚è¿™ç§è®¾è®¡å¸¦æ¥æé«˜çš„çµæ´»æ€§ï¼š

```mermaid
graph TB
    A[Engine æ ¸å¿ƒ] --> B{System Manager}
    
    B --> C[æ ¸å¿ƒç³»ç»Ÿ]
    B --> D[å¯é€‰ç³»ç»Ÿ]
    B --> E[è‡ªå®šä¹‰ç³»ç»Ÿ]
    
    C --> C1[EventSystem<br/>å¿…éœ€]
    C --> C2[RenderSystem<br/>å¿…éœ€]
    
    D --> D1[DragSystem<br/>æ‹–æ‹½åŠŸèƒ½]
    D --> D2[ZoomSystem<br/>ç¼©æ”¾åŠŸèƒ½]
    D --> D3[FpsSystem<br/>æ€§èƒ½ç›‘æ§]
    
    E --> E1[UndoRedoSystem<br/>æ’¤é”€é‡åš]
    E --> E2[SnappingSystem<br/>å¸é™„å¯¹é½]
    E --> E3[AnimationSystem<br/>åŠ¨ç”»æ’­æ”¾]
    
    style C1 fill:#e74c3c,color:#fff
    style C2 fill:#e74c3c,color:#fff
    style D1 fill:#3498db,color:#fff
    style D2 fill:#3498db,color:#fff
    style D3 fill:#3498db,color:#fff
    style E1 fill:#2ecc71,color:#fff
    style E2 fill:#2ecc71,color:#fff
    style E3 fill:#2ecc71,color:#fff
```

### æ ¸å¿ƒç³»ç»Ÿè¯¦è§£

#### 1. EventSystem - äº‹ä»¶æ€»çº¿

EventSystem æ˜¯æ•´ä¸ªå¼•æ“çš„è°ƒåº¦ä¸­æ¢ï¼Œåè°ƒæ‰€æœ‰å…¶ä»–ç³»ç»Ÿçš„æ‰§è¡Œï¼š

```typescript
class EventSystem extends System {
  private eventQueue: Event[] = []
  
  update(stateStore: StateStore) {
    // æ‰§è¡Œç³»ç»Ÿæ›´æ–°é¡ºåº
    this.executeSystem('InputSystem')      // 1. æ•è·è¾“å…¥
    this.executeSystem('HoverSystem')      // 2. æ£€æµ‹æ‚¬åœ
    this.executeSystem('ClickSystem')      // 3. å¤„ç†ç‚¹å‡»
    this.executeSystem('DragSystem')       // 4. å¤„ç†æ‹–æ‹½
    this.executeSystem('ZoomSystem')       // 5. å¤„ç†ç¼©æ”¾
    this.executeSystem('SelectionSystem')  // 6. æ›´æ–°é€‰æ‹©
    this.executeSystem('PickingSystem')    // 7. æ›´æ–°æ‹¾å–ç¼“å­˜
    this.executeSystem('RenderSystem')     // 8. æœ€åæ¸²æŸ“
  }

}
```

#### 2. RenderSystem - æ¸²æŸ“ç³»ç»Ÿ

RenderSystem è´Ÿè´£å°†å®ä½“ç»˜åˆ¶åˆ°ç”»å¸ƒï¼š

```typescript
class RenderSystem extends System {
  private renderMap = new Map<string, BaseRenderer>()
  
  constructor(engine: Engine) {
    super()
    this.engine = engine
    this.initRenderMap()
  }
  
  // åˆå§‹åŒ–æ¸²æŸ“å™¨æ˜ å°„
  initRenderMap() {
    Object.entries(this.engine.rendererManager.renderer).forEach(
      ([type, RendererClass]) => {
        this.renderMap.set(type, new RendererClass(this.engine))
      }
    )
  }
  
  async update(stateStore: StateStore) {
    // æ¸…ç©ºç”»å¸ƒ
    this.engine.clear()
    
    // åº”ç”¨ç›¸æœºå˜æ¢
    this.engine.canvas.save()
    this.engine.canvas.translate(
      this.engine.camera.translateX,
      this.engine.camera.translateY
    )
    this.engine.canvas.scale(
      this.engine.camera.zoom,
      this.engine.camera.zoom
    )
    
    // éå†æ‰€æœ‰å®ä½“è¿›è¡Œæ¸²æŸ“
    for (const [entityId, pos] of stateStore.position) {
      this.engine.canvas.save()
      this.engine.canvas.translate(pos.x, pos.y)
      
      const type = stateStore.type.get(entityId)
      await this.renderMap.get(type)?.draw(entityId)
      
      this.engine.canvas.restore()
    }
    
    this.engine.canvas.restore()
  }
}
```

## DSL é…ç½®ç³»ç»Ÿ

---

## DSL é…ç½®ç³»ç»Ÿ

### è®¾è®¡ç›®æ ‡

DSLï¼ˆDomain Specific Languageï¼‰æ¨¡å—çš„ç›®æ ‡æ˜¯å°†å›¾å½¢åœºæ™¯åºåˆ—åŒ–ä¸º JSON æ ¼å¼ï¼Œå®ç°ï¼š

1. **åœºæ™¯æŒä¹…åŒ–** - ä¿å­˜åˆ°æ•°æ®åº“æˆ–æœ¬åœ°å­˜å‚¨
2. **åœºæ™¯ä¼ è¾“** - å‰åç«¯æ•°æ®äº¤æ¢
3. **åœºæ™¯å¿«ç…§** - æ’¤é”€/é‡åšåŠŸèƒ½çš„åŸºç¡€
4. **æ¨¡æ¿å¤ç”¨** - åˆ›å»ºå¯å¤ç”¨çš„å›¾å½¢æ¨¡æ¿

### é…ç½®ç»“æ„

```typescript
interface DSLParams {
  type: 'rect' | 'ellipse' | 'text' | 'img' | 'polygon'
  id?: string
  position: { x: number; y: number }
  size?: { width: number; height: number }
  color?: { fill: string; stroke: string }
  rotation?: { value: number }
  scale?: { value: number }
  zIndex?: { value: number }
  selected?: { isSelected: boolean }
  // å½¢çŠ¶ç‰¹å®šå±æ€§
  font?: { family: string; size: number; weight: string }
  radius?: { value: number }
  polygon?: { points: Point[] }
}
```

### DSL è§£æå™¨

```typescript
class DSL {
  constructor(params: DSLParams) {
    this.type = params.type
    this.id = params.id || this.generateId()
    this.position = new Position(params.position)
    this.size = params.size ? new Size(params.size) : new Size()
    this.color = params.color ? new Color(params.color) : new Color()
    // ... åˆå§‹åŒ–å…¶ä»–ç»„ä»¶
  }
  
  // è½¬æ¢ä¸ºçº¯æ•°æ®å¯¹è±¡
  toJSON(): DSLParams {
    return {
      type: this.type,
      id: this.id,
      position: { x: this.position.x, y: this.position.y },
      size: { width: this.size.width, height: this.size.height },
      color: { fill: this.color.fill, stroke: this.color.stroke },
      // ...
    }
  }
}
```

---

## ä½è€¦åˆæ¶æ„å®è·µ

### ä¾èµ–æ–¹å‘

æ•´ä¸ªå¼•æ“ä¸¥æ ¼éµå¾ªä¾èµ–å€’ç½®åŸåˆ™ï¼š

```mermaid
graph TB
    A[åº”ç”¨å±‚<br/>React ç»„ä»¶] --> B[å¼•æ“æ¥å£<br/>Engine API]
    B --> C[ç³»ç»Ÿå±‚<br/>System]
    C --> D[ç»„ä»¶å±‚<br/>Component]
    C --> E[å®ä½“å±‚<br/>Entity]
    
    F[æ¸²æŸ“å±‚<br/>Renderer] --> G[æ¸²æŸ“æ¥å£<br/>BaseRenderer]
    C --> G
    
    style B fill:#f39c12,color:#fff
    style G fill:#f39c12,color:#fff
```

**å…³é”®è®¾è®¡ï¼š**
- ä¸Šå±‚ä¾èµ–æ¥å£ï¼Œä¸ä¾èµ–å…·ä½“å®ç°
- System ä¸ç›´æ¥ä¾èµ– Rendererï¼Œé€šè¿‡ RendererManager è§£è€¦
- Component çº¯æ•°æ®ï¼Œé›¶ä¾èµ–

---

## æ€»ç»“

Duck-Core å‰ç«¯æ¸²æŸ“å¼•æ“é€šè¿‡ä»¥ä¸‹è®¾è®¡å®ç°äº†é«˜æ€§èƒ½ã€é«˜æ‰©å±•æ€§ï¼š

### æ ¸å¿ƒä¼˜åŠ¿

1. **ECS æ¶æ„** - æ•°æ®ä¸é€»è¾‘å®Œå…¨åˆ†ç¦»ï¼Œç»„ä»¶è‡ªç”±ç»„åˆ
2. **åŒå¼•æ“æ¶æ„** - Canvas2D ä¸ CanvasKit å¯çƒ­åˆ‡æ¢ï¼Œå…¼é¡¾å…¼å®¹æ€§ä¸æ€§èƒ½
3. **æ’ä»¶åŒ–ç³»ç»Ÿ** - æ‰€æœ‰åŠŸèƒ½ä»¥ System å½¢å¼å®ç°ï¼ŒæŒ‰éœ€åŠ è½½
5. **ä½è€¦åˆè®¾è®¡** - æ¥å£éš”ç¦»ã€ä¾èµ–å€’ç½®ã€äº‹ä»¶é©±åŠ¨
6. **æè‡´æ€§èƒ½** - æ¸²æŸ“èŠ‚æµã€ç¦»å±ç¼“å­˜ã€è§†å£è£å‰ªã€å†…å­˜ä¼˜åŒ–



