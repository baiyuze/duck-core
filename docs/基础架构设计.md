# Duck-Core å‰ç«¯æ¸²æŸ“å¼•æ“æ¶æ„æ–‡æ¡£

## é¡¹ç›®æ¦‚è§ˆ

Duck-Core æ˜¯ä¸€ä¸ªåŸºäº **ECSï¼ˆEntity-Component-Systemï¼‰æ¶æ„**æ„å»ºçš„é«˜æ€§èƒ½ Canvas æ¸²æŸ“å¼•æ“ï¼Œä¸“ä¸ºå¤æ‚å›¾å½¢ç¼–è¾‘åœºæ™¯è®¾è®¡ã€‚å¼•æ“çš„æ ¸å¿ƒç‰¹è‰²åœ¨äº**åŒæ¸²æŸ“åç«¯æ¶æ„**ã€**æ’ä»¶åŒ–ç³»ç»Ÿè®¾è®¡**å’Œ**æè‡´çš„æ¸²æŸ“æ€§èƒ½ä¼˜åŒ–**ã€‚

### æ ¸å¿ƒæŠ€æœ¯æ ˆ

- **React 19** + **TypeScript 5.8** - ç±»å‹å®‰å…¨çš„ç”¨æˆ·ç•Œé¢
- **CanvasKit-WASM** - Google Skia å›¾å½¢åº“çš„ WebAssembly ç§»æ¤ç‰ˆ
- **Canvas2D API** - æµè§ˆå™¨åŸç”Ÿæ¸²æŸ“æ¥å£
- **Vite 7.x** - å¿«é€Ÿæ„å»ºå·¥å…·

### æ¶æ„æ ¸å¿ƒäº®ç‚¹

ğŸ¯ **ECS æ¶æ„æ¨¡å¼** - æ•°æ®é©±åŠ¨çš„å®ä½“ç»„ä»¶ç³»ç»Ÿï¼Œå®ç°é€»è¾‘ä¸æ•°æ®å®Œå…¨è§£è€¦

ğŸš€ **åŒå¼•æ“æ¶æ„** - Canvas2D ä¸ CanvasKit åŒæ¸²æŸ“åç«¯ï¼Œè¿è¡Œæ—¶æ— ç¼åˆ‡æ¢

ğŸ”Œ **æ’ä»¶åŒ–è®¾è®¡** - å¼€æ”¾å¼æ‰©å±•ç‚¹ï¼Œæ”¯æŒè‡ªå®šä¹‰æ¸²æŸ“å™¨ã€ç³»ç»Ÿå’Œç»„ä»¶

âš¡ **æè‡´æ€§èƒ½** - é¢œè‰²ç¼–ç æ‹¾å–ã€ç¦»å±æ¸²æŸ“ã€æ¸²æŸ“èŠ‚æµç­‰å¤šé‡ä¼˜åŒ–

---

## æ•´ä½“æ¶æ„è®¾è®¡

æ•´ä¸ªå¼•æ“é‡‡ç”¨åˆ†å±‚æ¶æ„ï¼Œä»åº•å±‚çš„æ¸²æŸ“æŠ½è±¡åˆ°é¡¶å±‚çš„ç”¨æˆ·äº¤äº’ï¼Œæ¯ä¸€å±‚èŒè´£æ¸…æ™°ä¸”å¯ç‹¬ç«‹æ›¿æ¢ã€‚

```mermaid
graph TB
    subgraph "åº”ç”¨å±‚"
        A[React ç»„ä»¶] --> B[Canvas ç”»å¸ƒç»„ä»¶]
    end
    
    subgraph "å¼•æ“æ ¸å¿ƒå±‚"
        B --> C[Engine å¼•æ“å®ä¾‹]
        C --> D[Core çŠ¶æ€ç®¡ç†å™¨]
        C --> E[Camera ç›¸æœºæ§åˆ¶]
        C --> F[Entity Manager å®ä½“ç®¡ç†]
    end
    
    subgraph "ç³»ç»Ÿå±‚ - System"
        C --> G[EventSystem äº‹ä»¶ç³»ç»Ÿ]
        G --> H[InputSystem è¾“å…¥ç³»ç»Ÿ]
        G --> I[RenderSystem æ¸²æŸ“ç³»ç»Ÿ]
        G --> J[PickingSystem æ‹¾å–ç³»ç»Ÿ]
        G --> K[DragSystem æ‹–æ‹½ç³»ç»Ÿ]
        G --> L[SelectionSystem é€‰æ‹©ç³»ç»Ÿ]
        G --> M[ZoomSystem ç¼©æ”¾ç³»ç»Ÿ]
    end
    
    subgraph "æ¸²æŸ“å±‚ - Renderer"
        I --> N[RendererManager æ¸²æŸ“ç®¡ç†å™¨]
        N --> O{é€‰æ‹©æ¸²æŸ“åç«¯}
        O -->|Canvas2D| P[Canvas2D æ¸²æŸ“å™¨ç»„]
        O -->|CanvasKit| Q[CanvasKit æ¸²æŸ“å™¨ç»„]
        P --> R[RectRender]
        P --> S[EllipseRender]
        P --> T[TextRender]
        Q --> U[RectRender]
        Q --> V[EllipseRender]
        Q --> W[TextRender]
    end
    
    subgraph "æ•°æ®å±‚ - Component"
        X[StateStore çŠ¶æ€ä»“åº“]
        X --> Y[Position]
        X --> Z[Size]
        X --> AA[Color]
        X --> AB[Rotation]
        X --> AC[Selected]
    end
    
    D <--> X
    I --> X
    J --> X
    K --> X
    L --> X
    
    style C fill:#4A90E2,color:#fff
    style N fill:#E94B3C,color:#fff
    style X fill:#6ECB63,color:#fff
    style G fill:#F39C12,color:#fff
```

---

## ECS æ¶æ„æ·±åº¦è§£æ

### ä»€ä¹ˆæ˜¯ ECS æ¶æ„ï¼Ÿ

ECSï¼ˆEntity-Component-Systemï¼‰æ˜¯ä¸€ç§æºè‡ªæ¸¸æˆå¼•æ“çš„è®¾è®¡æ¨¡å¼ï¼Œå®ƒå½»åº•æ”¹å˜äº†ä¼ ç»Ÿé¢å‘å¯¹è±¡çš„ç»§æ‰¿ä½“ç³»ï¼Œè½¬è€Œé‡‡ç”¨**ç»„åˆä¼˜äºç»§æ‰¿**çš„ç†å¿µã€‚

**ä¸‰å¤§æ ¸å¿ƒæ¦‚å¿µï¼š**

1. **Entityï¼ˆå®ä½“ï¼‰** - ä»…æ˜¯ä¸€ä¸ªå”¯ä¸€ IDï¼Œä¸åŒ…å«ä»»ä½•æ•°æ®å’Œé€»è¾‘
2. **Componentï¼ˆç»„ä»¶ï¼‰** - çº¯æ•°æ®ç»“æ„ï¼Œæè¿°å®ä½“çš„å±æ€§ï¼ˆå¦‚ä½ç½®ã€é¢œè‰²ã€å¤§å°ï¼‰
3. **Systemï¼ˆç³»ç»Ÿï¼‰** - çº¯é€»è¾‘å¤„ç†å•å…ƒï¼Œæ“ä½œç‰¹å®šç»„ä»¶ç»„åˆçš„å®ä½“

```mermaid
graph TB
    subgraph "ä¼ ç»Ÿ OOP ç»§æ‰¿æ–¹å¼"
        A1[GameObject]
        A1 --> A2[Rectangle]
        A1 --> A3[Circle]
        A1 --> A4[Text]
        A2 --> A5[DraggableRectangle]
        A3 --> A6[SelectableCircle]
        style A1 fill:#ff9999
    end
    
    subgraph "ECS ç»„åˆæ–¹å¼"
        B1[Entity 123] -.æ‹¥æœ‰.-> B2[Position]
        B1 -.æ‹¥æœ‰.-> B3[Size]
        B1 -.æ‹¥æœ‰.-> B4[Color]
        
        B5[Entity 456] -.æ‹¥æœ‰.-> B6[Position]
        B5 -.æ‹¥æœ‰.-> B7[Font]
        B5 -.æ‹¥æœ‰.-> B8[Selected]
        
        B9[RenderSystem] --> B2 & B3 & B4
        B10[DragSystem] --> B2
        B11[SelectionSystem] --> B8
        
        style B1 fill:#99ccff
        style B5 fill:#99ccff
        style B9 fill:#99ff99
        style B10 fill:#99ff99
        style B11 fill:#99ff99
    end
```

### ECS æ¶æ„çš„æ ¸å¿ƒä¼˜åŠ¿

#### 1. æè‡´çš„è§£è€¦æ€§

ä¼ ç»Ÿ OOP ä¸­ï¼ŒåŠŸèƒ½é€šè¿‡ç»§æ‰¿é“¾ç´§å¯†è€¦åˆã€‚è€Œ ECS ä¸­ï¼Œç³»ç»Ÿåªä¾èµ–ç»„ä»¶æ¥å£ï¼Œå®ä½“çš„è¡Œä¸ºå®Œå…¨ç”±ç»„ä»¶ç»„åˆå†³å®šã€‚

```typescript
// âŒ ä¼ ç»Ÿæ–¹å¼ï¼šç´§è€¦åˆçš„ç»§æ‰¿é“¾
class Shape {
  render() { /* ... */ }
}
class DraggableShape extends Shape {
  drag() { /* ... */ }
}
class SelectableDraggableShape extends DraggableShape {
  select() { /* ... */ }
}

// âœ… ECS æ–¹å¼ï¼šç»„ä»¶è‡ªç”±ç»„åˆ
const rect = createEntity()
addComponent(rect, Position, { x: 100, y: 100 })
addComponent(rect, Size, { width: 200, height: 150 })
addComponent(rect, Draggable, {})  // å¯æ‹–æ‹½
addComponent(rect, Selected, {})   // å¯é€‰ä¸­
```

#### 2. å¼ºå¤§çš„å¯æ‰©å±•æ€§

æ–°å¢åŠŸèƒ½æ— éœ€ä¿®æ”¹ç°æœ‰ä»£ç ï¼Œåªéœ€æ·»åŠ æ–°çš„ç»„ä»¶å’Œç³»ç»Ÿï¼š

```mermaid
graph LR
    A[éœ€æ±‚ï¼šæ·»åŠ æ—‹è½¬åŠŸèƒ½] --> B[1. åˆ›å»º Rotation ç»„ä»¶]
    B --> C[2. åˆ›å»º RotationSystem]
    C --> D[3. ä¿®æ”¹ RenderSystem<br/>è¯»å– Rotation æ•°æ®]
    D --> E[å®Œæˆï¼æ— éœ€ä¿®æ”¹å…¶ä»–ä»£ç ]
    
    style A fill:#ffffcc
    style E fill:#ccffcc
```

#### 3. å¤©ç„¶çš„å¹¶è¡Œå¤„ç†èƒ½åŠ›

ç³»ç»Ÿä¹‹é—´æ— å…±äº«çŠ¶æ€ï¼Œå¯ä»¥å®‰å…¨åœ°å¹¶è¡Œæ‰§è¡Œï¼š

```typescript
// å¤šä¸ªç³»ç»Ÿå¯ä»¥åŒæ—¶è¯»å–åŒä¸€ä¸ªç»„ä»¶
async function updateFrame() {
  await Promise.all([
    physicsSystem.update(),   // è¯»å– Position
    renderSystem.update(),    // è¯»å– Position
    collisionSystem.update(), // è¯»å– Position
  ])
}
```

#### 4. å†…å­˜å±€éƒ¨æ€§ä¼˜åŒ–

ç»„ä»¶æ•°æ®æŒ‰ç±»å‹é›†ä¸­å­˜å‚¨ï¼ŒCPU ç¼“å­˜å‘½ä¸­ç‡é«˜ï¼š

```mermaid
graph TB
    subgraph "ä¼ ç»Ÿ OOP å†…å­˜å¸ƒå±€"
        A1[å¯¹è±¡1: x,y,w,h,color,...]
        A2[å¯¹è±¡2: x,y,w,h,color,...]
        A3[å¯¹è±¡3: x,y,w,h,color,...]
    end
    
    subgraph "ECS å†…å­˜å¸ƒå±€ï¼ˆSoAï¼‰"
        B1[Position: x1,y1,x2,y2,x3,y3...]
        B2[Size: w1,h1,w2,h2,w3,h3...]
        B3[Color: c1,c2,c3...]
    end
    
    C[éå†æ‰€æœ‰ä½ç½®] --> B1
    C -.è·³è¿‡æ— å…³æ•°æ®.-> B2
    C -.è·³è¿‡æ— å…³æ•°æ®.-> B3
    
    D[éå†æ‰€æœ‰å¯¹è±¡] --> A1 & A2 & A3
    
    style B1 fill:#ccffcc
    style C fill:#ffcc99
```

### æœ¬å¼•æ“çš„ ECS å®ç°

#### Entity å®ä½“ç®¡ç†

å®ä½“ä»…æ˜¯ä¸€ä¸ªæ•°å­— IDï¼Œé€šè¿‡é¢œè‰²ç¼–ç ç®—æ³•ç”Ÿæˆå”¯ä¸€æ ‡è¯†ï¼š

```typescript
class Entity {
  private id: number = 1
  
  createEntity(): string {
    const colorId = this.idToRGBA(this.id)
    this.id++
    return colorId.join('') // è¿”å›å¦‚ "255100050255"
  }
  
  // ID è½¬ RGBA é¢œè‰²ï¼ˆç”¨äºæ‹¾å–ï¼‰
  idToRGBA(id: number): [r, g, b, a] {
    return [
      (id >> 16) & 0xff,
      (id >> 8) & 0xff,
      id & 0xff,
      255
    ]
  }
}
```

#### Component ç»„ä»¶ä½“ç³»

ç»„ä»¶æ˜¯çº¯æ•°æ®ç±»ï¼Œä¸åŒ…å«ä»»ä½•æ–¹æ³•ï¼š

```typescript
// åŸºç¡€ç»„ä»¶ç¤ºä¾‹
class Position {
  constructor(public x: number = 0, public y: number = 0) {}
}

class Size {
  constructor(public width: number = 100, public height: number = 100) {}
}

class Color {
  constructor(
    public fill: string = '#000000',
    public stroke: string = '#000000'
  ) {}
}

class Selected {
  constructor(public isSelected: boolean = false) {}
}
```

**ç»„ä»¶å®Œæ•´åˆ—è¡¨ï¼š**

| ç»„ä»¶ç±»å‹ | ç»„ä»¶å | æ•°æ®ç»“æ„ | ç”¨é€” |
|---------|--------|---------|------|
| **å‡ ä½•ç»„ä»¶** | Position | `{ x, y }` | å®ä½“ä½ç½® |
| | Size | `{ width, height }` | å®ä½“å°ºå¯¸ |
| | Rotation | `{ value }` | æ—‹è½¬è§’åº¦ï¼ˆå¼§åº¦ï¼‰ |
| | Scale | `{ value }` | ç¼©æ”¾æ¯”ä¾‹ |
| **è§†è§‰ç»„ä»¶** | Color | `{ fill, stroke }` | å¡«å……ä¸æè¾¹è‰² |
| | Font | `{ family, size, weight }` | å­—ä½“æ ·å¼ |
| | LineWidth | `{ value }` | çº¿æ¡å®½åº¦ |
| | Img | `{ src, loaded }` | å›¾ç‰‡èµ„æº |
| **å½¢çŠ¶ç»„ä»¶** | Radius | `{ value }` | åœ†è§’åŠå¾„ |
| | EllipseRadius | `{ rx, ry }` | æ¤­åœ†åŠå¾„ |
| | Polygon | `{ points[] }` | å¤šè¾¹å½¢é¡¶ç‚¹ |
| **äº¤äº’ç»„ä»¶** | Selected | `{ isSelected }` | é€‰ä¸­çŠ¶æ€ |
| | ZIndex | `{ value }` | æ¸²æŸ“å±‚çº§ |
| | Name | `{ value }` | å®ä½“åç§° |

#### StateStore çŠ¶æ€å­˜å‚¨

ä½¿ç”¨ Map ç»“æ„å­˜å‚¨ç»„ä»¶æ•°æ®ï¼Œkey ä¸ºå®ä½“ IDï¼Œvalue ä¸ºç»„ä»¶å®ä¾‹ï¼š

```typescript
interface StateStore {
  type: Map<EntityId, ShapeType>
  position: Map<EntityId, Position>
  size: Map<EntityId, Size>
  color: Map<EntityId, Color>
  selected: Map<EntityId, Selected>
  rotation: Map<EntityId, Rotation>
  // ... æ›´å¤šç»„ä»¶æ˜ å°„
}
```

#### System ç³»ç»Ÿæ¶æ„

ç³»ç»Ÿè´Ÿè´£å¤„ç†é€»è¾‘ï¼Œé€šè¿‡æŸ¥è¯¢ StateStore è·å–éœ€è¦çš„ç»„ä»¶æ•°æ®ï¼š

```typescript
abstract class System {
  abstract update(stateStore: StateStore): void
}

class RenderSystem extends System {
  update(stateStore: StateStore) {
    // æŸ¥è¯¢æ‰€æœ‰æ‹¥æœ‰ Position ç»„ä»¶çš„å®ä½“
    for (const [entityId, position] of stateStore.position) {
      const size = stateStore.size.get(entityId)
      const color = stateStore.color.get(entityId)
      const type = stateStore.type.get(entityId)
      
      // æ ¹æ®ç±»å‹è°ƒç”¨å¯¹åº”çš„æ¸²æŸ“å™¨
      this.renderMap.get(type)?.draw(entityId)
    }
  }
}
```

**ç³»ç»Ÿå®Œæ•´åˆ—è¡¨ï¼š**

```mermaid
graph TB
    A[EventSystem<br/>äº‹ä»¶æ€»çº¿] --> B[InputSystem<br/>è¾“å…¥æ•è·]
    A --> C[HoverSystem<br/>æ‚¬åœæ£€æµ‹]
    A --> D[ClickSystem<br/>ç‚¹å‡»å¤„ç†]
    A --> E[DragSystem<br/>æ‹–æ‹½é€»è¾‘]
    A --> F[SelectionSystem<br/>é€‰æ‹©ç®¡ç†]
    A --> G[ZoomSystem<br/>ç¼©æ”¾æ§åˆ¶]
    A --> H[ScrollSystem<br/>æ»šåŠ¨å¹³ç§»]
    A --> I[PickingSystem<br/>å›¾å½¢æ‹¾å–]
    A --> J[RenderSystem<br/>æ¸²æŸ“ç»˜åˆ¶]
    A --> K[FpsSystem<br/>æ€§èƒ½ç›‘æ§]
    
    style A fill:#F39C12,color:#fff
    style J fill:#E74C3C,color:#fff
    style I fill:#3498DB,color:#fff
```

### ECS å¸¦æ¥çš„å®é™…å¥½å¤„

#### æ¡ˆä¾‹ 1ï¼šå¿«é€Ÿæ·»åŠ å¤šé€‰åŠŸèƒ½

```typescript
// åªéœ€åœ¨ SelectionSystem ä¸­æ·»åŠ é€»è¾‘
class SelectionSystem extends System {
  update(stateStore: StateStore) {
    // æ¡†é€‰æ¨¡å¼
    if (this.isBoxSelecting) {
      const box = this.getSelectionBox()
      for (const [id, pos] of stateStore.position) {
        const size = stateStore.size.get(id)
        if (this.isIntersect(box, pos, size)) {
          const selected = stateStore.selected.get(id)
          selected.isSelected = true  // ä¿®æ”¹ç»„ä»¶æ•°æ®
        }
      }
    }
  }
}
```

#### æ¡ˆä¾‹ 2ï¼šè½»æ¾å®ç°å›¾å±‚åŠŸèƒ½

```typescript
// 1. æ·»åŠ  ZIndex ç»„ä»¶
class ZIndex {
  constructor(public value: number = 0) {}
}

// 2. ä¿®æ”¹ RenderSystem æ’åºé€»è¾‘
class RenderSystem extends System {
  render(stateStore: StateStore) {
    const entities = Array.from(stateStore.position.keys())
    
    // æŒ‰ ZIndex æ’åº
    entities.sort((a, b) => {
      const zA = stateStore.zIndex.get(a)?.value ?? 0
      const zB = stateStore.zIndex.get(b)?.value ?? 0
      return zA - zB
    })
    
    entities.forEach(id => this.drawShape(stateStore, id))
  }
}
```

#### æ¡ˆä¾‹ 3ï¼šæ€§èƒ½åˆ†æç³»ç»Ÿçƒ­æ’æ‹”

```typescript
// å¼€å‘æ—¶å¯ç”¨
engine.addSystem(new FpsSystem(engine))

// ç”Ÿäº§ç¯å¢ƒç§»é™¤ï¼ˆé›¶è¿è¡Œæ—¶å¼€é”€ï¼‰
// engine.addSystem(new FpsSystem(engine))
```

---

## åŒå¼•æ“æ¶æ„è®¾è®¡

### æ¶æ„è®¾è®¡ç†å¿µ

ä¸åŒçš„åº”ç”¨åœºæ™¯å¯¹æ¸²æŸ“å¼•æ“æœ‰ä¸åŒçš„éœ€æ±‚ï¼š

- **ç®€å•åœºæ™¯**ï¼šéœ€è¦å¿«é€Ÿå¯åŠ¨ã€ä½“ç§¯å°ã€å…¼å®¹æ€§å¥½
- **å¤æ‚åœºæ™¯**ï¼šéœ€è¦é«˜æ€§èƒ½ã€ä¸°å¯Œç‰¹æ•ˆã€å¤§é‡å›¾å½¢

ä¼ ç»Ÿæ–¹æ¡ˆé€šå¸¸åªæ”¯æŒå•ä¸€æ¸²æŸ“åç«¯ï¼Œéš¾ä»¥å…¼é¡¾ä¸¤è€…ã€‚æœ¬å¼•æ“åˆ›æ–°æ€§åœ°é‡‡ç”¨**åŒå¼•æ“å¯åˆ‡æ¢æ¶æ„**ï¼Œåœ¨è¿è¡Œæ—¶åŠ¨æ€é€‰æ‹©æœ€ä¼˜æ¸²æŸ“åç«¯ã€‚

```mermaid
graph TB
    A[åº”ç”¨å¯åŠ¨] --> B{æ£€æµ‹åœºæ™¯å¤æ‚åº¦}
    B -->|ç®€å•åœºæ™¯<br/>< 100 å›¾å½¢| C[Canvas2D å¼•æ“]
    B -->|å¤æ‚åœºæ™¯<br/>> 100 å›¾å½¢| D[CanvasKit å¼•æ“]
    B -->|ç”¨æˆ·æ‰‹åŠ¨æŒ‡å®š| E[ç”¨æˆ·é€‰æ‹©]
    
    C --> F[æµè§ˆå™¨åŸç”Ÿ API]
    D --> G[Skia WASM å¼•æ“]
    
    C --> H[æ¸²æŸ“è¾“å‡º]
    D --> H
    
    I[è¿è¡Œæ—¶åˆ‡æ¢] -.->|çƒ­åˆ‡æ¢| C
    I -.->|çƒ­åˆ‡æ¢| D
    
    style C fill:#90EE90
    style D fill:#87CEEB
    style H fill:#FFD700
```

### æ¸²æŸ“åç«¯å¯¹æ¯”

| ç‰¹æ€§ | Canvas2D | CanvasKit (Skia) |
|-----|----------|------------------|
| **å¯åŠ¨é€Ÿåº¦** | âš¡ï¸ å³æ—¶ï¼ˆ0msï¼‰ | ğŸ¢ éœ€åŠ è½½ WASMï¼ˆ~2sï¼‰ |
| **åŒ…ä½“ç§¯** | âœ… 0 KB | âš ï¸ ~1.5 MB |
| **æµè§ˆå™¨å…¼å®¹æ€§** | âœ… 100% | âš ï¸ éœ€æ”¯æŒ WASM |
| **æ¸²æŸ“æ€§èƒ½** | ğŸŸ¡ ä¸­ç­‰ | ğŸŸ¢ ä¼˜ç§€ |
| **å¤æ‚è·¯å¾„æ¸²æŸ“** | ğŸŸ¡ ä¸€èˆ¬ | ğŸŸ¢ ä¼˜ç§€ |
| **æ–‡å­—æ¸²æŸ“** | ğŸŸ¡ è´¨é‡ä¸€èˆ¬ | ğŸŸ¢ äºšåƒç´ çº§ |
| **æ»¤é•œç‰¹æ•ˆ** | âŒ æœ‰é™ | âœ… ä¸°å¯Œ |
| **ç¦»å±æ¸²æŸ“** | âœ… æ”¯æŒ | âœ… æ”¯æŒ |
| **æœ€ä½³åœºæ™¯** | ç®€å•å›¾å½¢ã€å¿«é€ŸåŸå‹ | å¤æ‚è®¾è®¡ã€é«˜æ€§èƒ½éœ€æ±‚ |

### RendererManager æ¸²æŸ“ç®¡ç†å™¨

`RendererManager` æ˜¯åŒå¼•æ“æ¶æ„çš„æ ¸å¿ƒæ¢çº½ï¼Œè´Ÿè´£æ¸²æŸ“å™¨çš„æ³¨å†Œã€åˆ‡æ¢å’Œè°ƒåº¦ï¼š

```typescript
class RendererManager {
  rendererName: 'Canvas2D' | 'Canvaskit' = 'Canvaskit'
  
  // æ¸²æŸ“å™¨æ˜ å°„è¡¨
  renderer: {
    rect: typeof RectRender
    ellipse: typeof EllipseRender
    text: typeof TextRender
    img: typeof ImgRender
    polygon: typeof PolygonRender
  }
  
  // åˆ‡æ¢æ¸²æŸ“åç«¯
  setRenderer(name: 'Canvas2D' | 'Canvaskit') {
    this.rendererName = name
    
    if (name === 'Canvas2D') {
      this.renderer = Canvas2DRenderers
    } else {
      this.renderer = CanvaskitRenderers
    }
  }
}
```

**æ¸²æŸ“å™¨åˆ‡æ¢æµç¨‹ï¼š**

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·æ“ä½œ
    participant E as Engine
    participant RM as RendererManager
    participant RS as RenderSystem
    participant R1 as Canvas2D Renderer
    participant R2 as CanvasKit Renderer
    
    U->>E: setRenderer('Canvas2D')
    E->>RM: setRenderer('Canvas2D')
    RM->>RM: åŠ è½½ Canvas2D æ¸²æŸ“å™¨ç»„
    RM-->>E: åˆ‡æ¢å®Œæˆ
    
    E->>RS: è§¦å‘é‡æ–°æ¸²æŸ“
    RS->>RM: è·å– rect æ¸²æŸ“å™¨
    RM-->>RS: è¿”å› Canvas2D.RectRender
    RS->>R1: è°ƒç”¨ draw() æ–¹æ³•
    R1->>R1: ä½¿ç”¨ ctx.fillRect()
    
    Note over U,R2: ç”¨æˆ·å†æ¬¡åˆ‡æ¢å¼•æ“
    
    U->>E: setRenderer('Canvaskit')
    E->>RM: setRenderer('Canvaskit')
    RM->>RM: åŠ è½½ CanvasKit æ¸²æŸ“å™¨ç»„
    RM-->>E: åˆ‡æ¢å®Œæˆ
    
    E->>RS: è§¦å‘é‡æ–°æ¸²æŸ“
    RS->>RM: è·å– rect æ¸²æŸ“å™¨
    RM-->>RS: è¿”å› CanvasKit.RectRender
    RS->>R2: è°ƒç”¨ draw() æ–¹æ³•
    R2->>R2: ä½¿ç”¨ canvas.drawRect()
```

### æ¸²æŸ“å™¨ç»Ÿä¸€æ¥å£

æ‰€æœ‰æ¸²æŸ“å™¨å®ç°ç›¸åŒçš„æ¥å£ï¼Œä¿è¯å¯æ›¿æ¢æ€§ï¼š

```typescript
abstract class BaseRenderer extends System {
  constructor(protected engine: Engine) {
    super()
  }
  
  // ç»Ÿä¸€çš„æ¸²æŸ“æ¥å£
  abstract draw(entityId: string): void
  
  // è·å–ç»„ä»¶æ•°æ®çš„è¾…åŠ©æ–¹æ³•
  protected getComponent<T>(entityId: string, componentName: string): T | undefined {
    return this.engine.stateStore[componentName].get(entityId)
  }
}
```

### Canvas2D æ¸²æŸ“å™¨å®ç°

```typescript
class Canvas2DRectRender extends BaseRenderer {
  draw(entityId: string) {
    const ctx = this.engine.ctx as CanvasRenderingContext2D
    const size = this.getComponent<Size>(entityId, 'size')
    const color = this.getComponent<Color>(entityId, 'color')
    const rotation = this.getComponent<Rotation>(entityId, 'rotation')
    
    if (!size) return
    
    ctx.save()
    
    // åº”ç”¨æ—‹è½¬
    if (rotation) {
      ctx.translate(size.width / 2, size.height / 2)
      ctx.rotate(rotation.value)
      ctx.translate(-size.width / 2, -size.height / 2)
    }
    
    // ç»˜åˆ¶çŸ©å½¢
    if (color?.fill) {
      ctx.fillStyle = color.fill
      ctx.fillRect(0, 0, size.width, size.height)
    }
    
    if (color?.stroke) {
      ctx.strokeStyle = color.stroke
      ctx.strokeRect(0, 0, size.width, size.height)
    }
    
    ctx.restore()
  }
}
```

### CanvasKit æ¸²æŸ“å™¨å®ç°

```typescript
class CanvaskitRectRender extends BaseRenderer {
  draw(entityId: string) {
    const canvas = this.engine.canvas  // CanvasKit Surface
    const ck = this.engine.ck
    const size = this.getComponent<Size>(entityId, 'size')
    const color = this.getComponent<Color>(entityId, 'color')
    const rotation = this.getComponent<Rotation>(entityId, 'rotation')
    
    if (!size) return
    
    canvas.save()
    
    // åº”ç”¨æ—‹è½¬
    if (rotation) {
      canvas.translate(size.width / 2, size.height / 2)
      canvas.rotate(rotation.value * 180 / Math.PI, 0, 0)
      canvas.translate(-size.width / 2, -size.height / 2)
    }
    
    const rect = ck.LTRBRect(0, 0, size.width, size.height)
    const paint = new ck.Paint()
    
    // ç»˜åˆ¶å¡«å……
    if (color?.fill) {
      paint.setColor(ck.parseColorString(color.fill))
      paint.setStyle(ck.PaintStyle.Fill)
      canvas.drawRect(rect, paint)
    }
    
    // ç»˜åˆ¶æè¾¹
    if (color?.stroke) {
      paint.setColor(ck.parseColorString(color.stroke))
      paint.setStyle(ck.PaintStyle.Stroke)
      canvas.drawRect(rect, paint)
    }
    
    paint.delete()
    canvas.restore()
  }
}
```

### è‡ªå®šä¹‰æ¸²æŸ“å™¨æ‰©å±•

å¼•æ“æ”¯æŒç”¨æˆ·è‡ªå®šä¹‰æ¸²æŸ“å™¨ï¼Œåªéœ€å®ç° `BaseRenderer` æ¥å£ï¼š

```typescript
// 1. åˆ›å»ºè‡ªå®šä¹‰æ¸²æŸ“å™¨
class CustomStarRender extends BaseRenderer {
  draw(entityId: string) {
    const points = this.getComponent<Polygon>(entityId, 'polygon')
    const color = this.getComponent<Color>(entityId, 'color')
    
    // è‡ªå®šä¹‰ç»˜åˆ¶é€»è¾‘
    const ctx = this.engine.ctx
    ctx.beginPath()
    points.points.forEach((p, i) => {
      i === 0 ? ctx.moveTo(p.x, p.y) : ctx.lineTo(p.x, p.y)
    })
    ctx.closePath()
    ctx.fillStyle = color.fill
    ctx.fill()
  }
}

// 2. æ³¨å†Œåˆ°å¼•æ“
engine.rendererManager.renderer.star = CustomStarRender

// 3. åˆ›å»ºä½¿ç”¨è¯¥æ¸²æŸ“å™¨çš„å®ä½“
const starEntity = createEntity({
  type: 'star',
  polygon: { points: calculateStarPoints() },
  color: { fill: '#FFD700' }
})
```

### å­—ä½“æ¸²æŸ“ä¼˜åŒ–

CanvasKit éœ€è¦é¢„åŠ è½½å­—ä½“æ–‡ä»¶ï¼Œå¼•æ“å®ç°äº†å­—ä½“ç®¡ç†å™¨ï¼š

```typescript
async function loadFonts(CanvasKit: any) {
  const fontsBase = import.meta.env?.MODE === 'production' 
    ? '/design/fonts/' 
    : '/fonts/'

  const [robotoFont, notoSansFont] = await Promise.all([
    fetch(`${fontsBase}Roboto-Regular.ttf`).then(r => r.arrayBuffer()),
    fetch(`${fontsBase}NotoSansSC-VariableFont_wght_2.ttf`).then(r => r.arrayBuffer()),
  ])

  const fontMgr = CanvasKit.FontMgr.FromData(robotoFont, notoSansFont)
  return fontMgr
}

// åœ¨ CanvasKit åˆå§‹åŒ–æ—¶è°ƒç”¨
export async function createCanvasKit() {
  const CanvasKit = await initCanvasKit()
  const FontMgr = await loadFonts(CanvasKit)
  return { CanvasKit, FontMgr }
}
```

### å¼•æ“å·¥å‚æ¨¡å¼

ä½¿ç”¨å·¥å‚å‡½æ•°åˆ›å»ºä¸åŒé…ç½®çš„å¼•æ“å®ä¾‹ï¼š

```typescript
export function createCanvasRenderer(engine: Engine) {
  // Canvas2D å¼•æ“åˆ›å»ºå™¨
  const createCanvas2D = (config: DefaultConfig) => {
    const canvas = document.createElement('canvas')
    const dpr = window.devicePixelRatio || 1
    canvas.style.width = config.width + 'px'
    canvas.style.height = config.height + 'px'
    canvas.width = config.width * dpr
    canvas.height = config.height * dpr
    
    const ctx = canvas.getContext('2d', {
      willReadFrequently: true,
    }) as CanvasRenderingContext2D
    ctx.scale(dpr, dpr)
    
    config.container.appendChild(canvas)
    
    return { canvasDom: canvas, canvas: ctx, ctx }
  }

  // CanvasKit å¼•æ“åˆ›å»ºå™¨
  const createCanvasKitSkia = async (config: DefaultConfig) => {
    const { CanvasKit, FontMgr } = await createCanvasKit()
    const canvasDom = document.createElement('canvas')
    const dpr = window.devicePixelRatio || 1
    
    canvasDom.style.width = config.width + 'px'
    canvasDom.style.height = config.height + 'px'
    canvasDom.width = config.width * dpr
    canvasDom.height = config.height * dpr
    canvasDom.id = 'canvasKitCanvas'
    
    config.container.appendChild(canvasDom)
    
    const surface = CanvasKit.MakeWebGLCanvasSurface('canvasKitCanvas')
    const canvas = surface!.getCanvas()
    
    return {
      canvasDom,
      surface,
      canvas: canvas,
      FontMgr: FontMgr,
      ck: CanvasKit,
    }
  }

  return {
    createCanvas2D,
    createCanvasKitSkia,
  }
}
```

### Engine å¼•æ“æ ¸å¿ƒ

`Engine` ç±»æ˜¯æ•´ä¸ªæ¸²æŸ“ç³»ç»Ÿçš„ä¸­æ¢ï¼Œåè°ƒæ‰€æœ‰å­ç³»ç»Ÿçš„è¿è¡Œï¼š

```typescript
class Engine implements EngineContext {
  camera: Camera = new Camera()
  entityManager: Entity = new Entity()
  SystemMap: Map<string, System> = new Map()
  rendererManager: RendererManager = new RendererManager()
  
  canvas!: Canvas  // æ¸²æŸ“ç”»å¸ƒï¼ˆç±»å‹å–å†³äºæ¸²æŸ“åç«¯ï¼‰
  ctx!: CanvasRenderingContext2D
  ck!: CanvasKit
  
  constructor(public core: Core, rendererName?: string) {
    // åˆå§‹åŒ–æ¸²æŸ“å™¨
    this.rendererManager.rendererName = rendererName || 'Canvaskit'
    this.rendererManager.setRenderer(this.rendererManager.rendererName)
  }
  
  // æ·»åŠ ç³»ç»Ÿ
  addSystem(system: System) {
    this.system.push(system)
    this.SystemMap.set(system.constructor.name, system)
  }
  
  // è·å–ç³»ç»Ÿ
  getSystemByName<T extends System>(name: string): T | undefined {
    return this.SystemMap.get(name) as T
  }
  
  // æ¸…ç©ºç”»å¸ƒï¼ˆé€‚é…åŒå¼•æ“ï¼‰
  clear() {
    const canvas = this.canvas as any
    if (canvas?.clearRect) {
      // Canvas2D æ¸…ç©ºæ–¹å¼
      canvas.clearRect(0, 0, this.defaultSize.width, this.defaultSize.height)
    } else {
      // CanvasKit æ¸…ç©ºæ–¹å¼
      this.canvas.clear(this.ck.WHITE)
    }
  }
}
```

---

## æ’ä»¶åŒ–ç³»ç»Ÿè®¾è®¡

### ç³»ç»Ÿå³æ’ä»¶

å¼•æ“çš„æ‰€æœ‰åŠŸèƒ½éƒ½ä»¥ System å½¢å¼å®ç°ï¼Œæ¯ä¸ª System éƒ½æ˜¯ç‹¬ç«‹çš„æ’ä»¶ã€‚è¿™ç§è®¾è®¡å¸¦æ¥æé«˜çš„çµæ´»æ€§ï¼š

```mermaid
graph TB
    A[Engine æ ¸å¿ƒ] --> B{System Manager}
    
    B --> C[æ ¸å¿ƒç³»ç»Ÿ]
    B --> D[å¯é€‰ç³»ç»Ÿ]
    B --> E[è‡ªå®šä¹‰ç³»ç»Ÿ]
    
    C --> C1[EventSystem<br/>å¿…éœ€]
    C --> C2[RenderSystem<br/>å¿…éœ€]
    
    D --> D1[DragSystem<br/>æ‹–æ‹½åŠŸèƒ½]
    D --> D2[ZoomSystem<br/>ç¼©æ”¾åŠŸèƒ½]
    D --> D3[FpsSystem<br/>æ€§èƒ½ç›‘æ§]
    
    E --> E1[UndoRedoSystem<br/>æ’¤é”€é‡åš]
    E --> E2[SnappingSystem<br/>å¸é™„å¯¹é½]
    E --> E3[AnimationSystem<br/>åŠ¨ç”»æ’­æ”¾]
    
    style C1 fill:#e74c3c,color:#fff
    style C2 fill:#e74c3c,color:#fff
    style D1 fill:#3498db,color:#fff
    style D2 fill:#3498db,color:#fff
    style D3 fill:#3498db,color:#fff
    style E1 fill:#2ecc71,color:#fff
    style E2 fill:#2ecc71,color:#fff
    style E3 fill:#2ecc71,color:#fff
```

### æ ¸å¿ƒç³»ç»Ÿè¯¦è§£

#### 1. EventSystem - äº‹ä»¶æ€»çº¿

EventSystem æ˜¯æ•´ä¸ªå¼•æ“çš„è°ƒåº¦ä¸­æ¢ï¼Œåè°ƒæ‰€æœ‰å…¶ä»–ç³»ç»Ÿçš„æ‰§è¡Œï¼š

```typescript
class EventSystem extends System {
  private eventQueue: Event[] = []
  
  update(stateStore: StateStore) {
    // æ‰§è¡Œç³»ç»Ÿæ›´æ–°é¡ºåº
    this.executeSystem('InputSystem')      // 1. æ•è·è¾“å…¥
    this.executeSystem('HoverSystem')      // 2. æ£€æµ‹æ‚¬åœ
    this.executeSystem('ClickSystem')      // 3. å¤„ç†ç‚¹å‡»
    this.executeSystem('DragSystem')       // 4. å¤„ç†æ‹–æ‹½
    this.executeSystem('ZoomSystem')       // 5. å¤„ç†ç¼©æ”¾
    this.executeSystem('SelectionSystem')  // 6. æ›´æ–°é€‰æ‹©
    this.executeSystem('PickingSystem')    // 7. æ›´æ–°æ‹¾å–ç¼“å­˜
    this.executeSystem('RenderSystem')     // 8. æœ€åæ¸²æŸ“
  }
  
  private executeSystem(name: string) {
    const system = this.engine.getSystemByName(name)
    system?.update(this.engine.stateStore)
  }
}
```

#### 2. RenderSystem - æ¸²æŸ“ç³»ç»Ÿ

RenderSystem è´Ÿè´£å°†å®ä½“ç»˜åˆ¶åˆ°ç”»å¸ƒï¼š

```typescript
class RenderSystem extends System {
  private renderMap = new Map<string, BaseRenderer>()
  
  constructor(engine: Engine) {
    super()
    this.engine = engine
    this.initRenderMap()
  }
  
  // åˆå§‹åŒ–æ¸²æŸ“å™¨æ˜ å°„
  initRenderMap() {
    Object.entries(this.engine.rendererManager.renderer).forEach(
      ([type, RendererClass]) => {
        this.renderMap.set(type, new RendererClass(this.engine))
      }
    )
  }
  
  async update(stateStore: StateStore) {
    // æ¸…ç©ºç”»å¸ƒ
    this.engine.clear()
    
    // åº”ç”¨ç›¸æœºå˜æ¢
    this.engine.canvas.save()
    this.engine.canvas.translate(
      this.engine.camera.translateX,
      this.engine.camera.translateY
    )
    this.engine.canvas.scale(
      this.engine.camera.zoom,
      this.engine.camera.zoom
    )
    
    // éå†æ‰€æœ‰å®ä½“è¿›è¡Œæ¸²æŸ“
    for (const [entityId, pos] of stateStore.position) {
      this.engine.canvas.save()
      this.engine.canvas.translate(pos.x, pos.y)
      
      const type = stateStore.type.get(entityId)
      await this.renderMap.get(type)?.draw(entityId)
      
      this.engine.canvas.restore()
    }
    
    this.engine.canvas.restore()
  }
}
```

#### 3. PickingSystem - æ‹¾å–ç³»ç»Ÿ

ä½¿ç”¨é¢œè‰²ç¼–ç ç®—æ³•å®ç°é«˜æ€§èƒ½å›¾å½¢æ‹¾å–ï¼š

```typescript
class PickingSystem extends System {
  private offCtx: CanvasRenderingContext2D
  private offscreenCanvas: HTMLCanvasElement
  
  constructor(engine: Engine) {
    super()
    this.engine = engine
    this.initOffscreenCanvas()
  }
  
  // åˆå§‹åŒ–ç¦»å± Canvas
  initOffscreenCanvas() {
    const { width, height } = this.engine.canvasDom!
    this.offscreenCanvas = document.createElement('canvas')
    this.offscreenCanvas.width = width
    this.offscreenCanvas.height = height
    this.offCtx = this.offscreenCanvas.getContext('2d', {
      willReadFrequently: true,
    })!
  }
  
  // æ¸²æŸ“é¢œè‰²ç¼–ç ç‰ˆæœ¬
  update(stateStore: StateStore) {
    const ctx = this.offCtx
    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height)
    
    ctx.save()
    ctx.translate(
      this.engine.camera.translateX,
      this.engine.camera.translateY
    )
    ctx.scale(this.engine.camera.zoom, this.engine.camera.zoom)
    
    // ç”¨å”¯ä¸€é¢œè‰²æ¸²æŸ“æ¯ä¸ªå®ä½“
    for (const [entityId, pos] of stateStore.position) {
      const size = stateStore.size.get(entityId)
      const fillColor = this.engine.entityManager.getColorById(entityId)
      
      ctx.fillStyle = fillColor
      ctx.fillRect(pos.x, pos.y, size.width, size.height)
    }
    
    ctx.restore()
  }
  
  // æ ¹æ®åæ ‡è·å–å®ä½“ ID
  pick(x: number, y: number): string | null {
    const pixel = this.offCtx.getImageData(x, y, 1, 1).data
    return this.engine.entityManager.rgbaToId([
      pixel[0], pixel[1], pixel[2], pixel[3]
    ])
  }
}
```

**æ‹¾å–åŸç†ç¤ºæ„ï¼š**

```mermaid
graph TB
    subgraph "ä¸»ç”»å¸ƒï¼ˆç”¨æˆ·å¯è§ï¼‰"
        A1[çŸ©å½¢ - è“è‰²]
        A2[åœ†å½¢ - çº¢è‰²]
        A3[æ–‡å­— - é»‘è‰²]
    end
    
    subgraph "ç¦»å±ç”»å¸ƒï¼ˆéšè—ï¼‰"
        B1[çŸ©å½¢ - rgb(0,0,1)]
        B2[åœ†å½¢ - rgb(0,0,2)]
        B3[æ–‡å­— - rgb(0,0,3)]
    end
    
    C[ç”¨æˆ·ç‚¹å‡» x,y] --> D[è¯»å–ç¦»å±ç”»å¸ƒåƒç´ ]
    D --> E{é¢œè‰²å€¼}
    E -->|rgb(0,0,1)| F[å®ä½“ ID: 1]
    E -->|rgb(0,0,2)| G[å®ä½“ ID: 2]
    E -->|rgb(0,0,3)| H[å®ä½“ ID: 3]
    
    style A1 fill:#4A90E2
    style A2 fill:#E74C3C
    style A3 fill:#34495E
    style B1 fill:#000001
    style B2 fill:#000002
    style B3 fill:#000003
```

#### 4. DragSystem - æ‹–æ‹½ç³»ç»Ÿ

```typescript
class DragSystem extends System {
  private isDragging = false
  private dragStartPos = { x: 0, y: 0 }
  private selectedEntities: string[] = []
  
  update(stateStore: StateStore) {
    if (this.isDragging) {
      const delta = this.calculateDelta()
      
      // æ›´æ–°æ‰€æœ‰é€‰ä¸­å®ä½“çš„ä½ç½®
      this.selectedEntities.forEach(id => {
        const pos = stateStore.position.get(id)
        if (pos) {
          pos.x += delta.x
          pos.y += delta.y
        }
      })
    }
  }
  
  onMouseDown(e: MouseEvent, selectedIds: string[]) {
    this.isDragging = true
    this.dragStartPos = { x: e.clientX, y: e.clientY }
    this.selectedEntities = selectedIds
  }
  
  onMouseUp() {
    this.isDragging = false
    this.selectedEntities = []
  }
}
```

#### 5. SelectionSystem - é€‰æ‹©ç³»ç»Ÿ

```typescript
class SelectionSystem extends System {
  private selectionBox: Box | null = null
  
  update(stateStore: StateStore) {
    if (this.selectionBox) {
      // æ¡†é€‰æ¨¡å¼
      this.boxSelect(stateStore)
    }
  }
  
  // å•é€‰
  selectOne(entityId: string, stateStore: StateStore) {
    // æ¸…é™¤å…¶ä»–é€‰æ‹©
    stateStore.selected.forEach((sel, id) => {
      sel.isSelected = (id === entityId)
    })
  }
  
  // æ¡†é€‰
  boxSelect(stateStore: StateStore) {
    const box = this.selectionBox!
    
    stateStore.position.forEach((pos, id) => {
      const size = stateStore.size.get(id)
      if (!size) return
      
      // æ£€æµ‹è¾¹ç•Œæ¡†ç›¸äº¤
      if (this.intersects(box, pos, size)) {
        const selected = stateStore.selected.get(id)
        if (selected) selected.isSelected = true
      }
    })
  }
}
```

#### 6. ZoomSystem - ç¼©æ”¾ç³»ç»Ÿ

```typescript
class ZoomSystem extends System {
  update(stateStore: StateStore) {
    // ç”± InputSystem è§¦å‘æ»šè½®äº‹ä»¶
  }
  
  onWheel(e: WheelEvent) {
    const zoomDelta = e.deltaY > 0 ? 0.9 : 1.1
    const newZoom = this.engine.camera.zoom * zoomDelta
    
    // é™åˆ¶ç¼©æ”¾èŒƒå›´
    this.engine.camera.zoom = Math.max(0.1, Math.min(5, newZoom))
    
    // æ ‡è®°éœ€è¦é‡æ–°æ¸²æŸ“
    this.engine.dirtyRender = true
  }
}
```

### è‡ªå®šä¹‰ç³»ç»Ÿç¤ºä¾‹

#### æ’¤é”€/é‡åšç³»ç»Ÿ

```typescript
class UndoRedoSystem extends System {
  private history: StateSnapshot[] = []
  private currentIndex = -1
  
  // ä¿å­˜å¿«ç…§
  takeSnapshot(stateStore: StateStore) {
    const snapshot = this.cloneState(stateStore)
    this.history = this.history.slice(0, this.currentIndex + 1)
    this.history.push(snapshot)
    this.currentIndex++
  }
  
  // æ’¤é”€
  undo(stateStore: StateStore) {
    if (this.currentIndex > 0) {
      this.currentIndex--
      this.restoreState(this.history[this.currentIndex], stateStore)
    }
  }
  
  // é‡åš
  redo(stateStore: StateStore) {
    if (this.currentIndex < this.history.length - 1) {
      this.currentIndex++
      this.restoreState(this.history[this.currentIndex], stateStore)
    }
  }
  
  update(stateStore: StateStore) {
    // ç›‘å¬ Ctrl+Z / Ctrl+Y
    // å®ç°ç•¥
  }
}

// ä½¿ç”¨
engine.addSystem(new UndoRedoSystem(engine))
```

#### å¸é™„å¯¹é½ç³»ç»Ÿ

```typescript
class SnappingSystem extends System {
  private snapThreshold = 5  // å¸é™„é˜ˆå€¼ï¼ˆåƒç´ ï¼‰
  
  update(stateStore: StateStore) {
    if (!this.isDragging) return
    
    const draggingEntity = this.getDraggingEntity()
    const draggingPos = stateStore.position.get(draggingEntity)!
    
    // éå†å…¶ä»–å®ä½“ï¼ŒæŸ¥æ‰¾å¯¹é½ç‚¹
    stateStore.position.forEach((pos, id) => {
      if (id === draggingEntity) return
      
      // æ£€æµ‹ X è½´å¯¹é½
      if (Math.abs(pos.x - draggingPos.x) < this.snapThreshold) {
        draggingPos.x = pos.x  // å¸é™„
        this.showGuideLine('vertical', pos.x)
      }
      
      // æ£€æµ‹ Y è½´å¯¹é½
      if (Math.abs(pos.y - draggingPos.y) < this.snapThreshold) {
        draggingPos.y = pos.y  // å¸é™„
        this.showGuideLine('horizontal', pos.y)
      }
    })
  }
}
```

### ç³»ç»Ÿæ’æ‹”ç¤ºæ„

```mermaid
graph LR
    A[åŸºç¡€å¼•æ“] --> B[æ·»åŠ ç³»ç»Ÿ]
    
    B --> C{éœ€è¦æ‹–æ‹½?}
    C -->|æ˜¯| D[engine.addSystem<br/>new DragSystem]
    C -->|å¦| E[è·³è¿‡]
    
    B --> F{éœ€è¦æ’¤é”€?}
    F -->|æ˜¯| G[engine.addSystem<br/>new UndoRedoSystem]
    F -->|å¦| H[è·³è¿‡]
    
    B --> I{éœ€è¦å¸é™„?}
    I -->|æ˜¯| J[engine.addSystem<br/>new SnappingSystem]
    I -->|å¦| K[è·³è¿‡]
    
    D --> L[å®Œæ•´åŠŸèƒ½å¼•æ“]
    E --> L
    G --> L
    H --> L
    J --> L
    K --> L
    
    style A fill:#ecf0f1
    style L fill:#2ecc71,color:#fff
```

---

## æ¸²æŸ“æ€§èƒ½ä¼˜åŒ–

### æ€§èƒ½ä¼˜åŒ–ç­–ç•¥æ€»è§ˆ

```mermaid
graph TB
    A[æ€§èƒ½ä¼˜åŒ–ç­–ç•¥] --> B[æ¸²æŸ“å±‚ä¼˜åŒ–]
    A --> C[æ‹¾å–å±‚ä¼˜åŒ–]
    A --> D[å†…å­˜ä¼˜åŒ–]
    A --> E[è®¡ç®—ä¼˜åŒ–]
    
    B --> B1[æ¸²æŸ“èŠ‚æµ]
    B --> B2[è„çŸ©å½¢æ£€æµ‹]
    B --> B3[è§†å£è£å‰ª]
    B --> B4[åŒå¼•æ“åˆ‡æ¢]
    
    C --> C1[ç¦»å±Canvasç¼“å­˜]
    C --> C2[é¢œè‰²ç¼–ç ç®—æ³• O1]
    C --> C3[æŒ‰éœ€æ›´æ–°]
    
    D --> D1[ECSå†…å­˜å¸ƒå±€]
    D --> D2[å¯¹è±¡æ± å¤ç”¨]
    D --> D3[ç»„ä»¶æ‡’åŠ è½½]
    
    E --> E1[ç©ºé—´ç´¢å¼•]
    E --> E2[äº‹ä»¶å§”æ‰˜]
    E --> E3[WebWorker]
    
    style B fill:#3498db,color:#fff
    style C fill:#e74c3c,color:#fff
    style D fill:#2ecc71,color:#fff
    style E fill:#f39c12,color:#fff
```

### 1. æ¸²æŸ“èŠ‚æµæœºåˆ¶

é«˜é¢‘äº¤äº’ï¼ˆå¦‚é¼ æ ‡ç§»åŠ¨ï¼‰ä¼šè§¦å‘å¤§é‡æ¸²æŸ“è¯·æ±‚ï¼Œä½¿ç”¨èŠ‚æµé¿å…æ€§èƒ½æµªè´¹ï¼š

```typescript
class RenderSystem extends System {
  private lastRenderTime = 0
  private renderThreshold = 100  // 100ms èŠ‚æµ
  
  async update(stateStore: StateStore) {
    const now = Date.now()
    
    // èŠ‚æµæ£€æŸ¥
    if (now - this.lastRenderTime < this.renderThreshold) {
      return
    }
    
    this.lastRenderTime = now
    await this.render(stateStore)
  }
}
```

**èŠ‚æµæ•ˆæœå¯¹æ¯”ï¼š**

```mermaid
gantt
    title æ¸²æŸ“é¢‘ç‡å¯¹æ¯”
    dateFormat X
    axisFormat %L ms
    
    section æ— èŠ‚æµ
    æ¸²æŸ“1 :0, 16
    æ¸²æŸ“2 :16, 32
    æ¸²æŸ“3 :32, 48
    æ¸²æŸ“4 :48, 64
    æ¸²æŸ“5 :64, 80
    æ¸²æŸ“6 :80, 96
    
    section 100msèŠ‚æµ
    æ¸²æŸ“1 :0, 16
    è·³è¿‡ :16, 100
    æ¸²æŸ“2 :100, 116
    è·³è¿‡ :116, 200
    æ¸²æŸ“3 :200, 216
```

### 2. é¢œè‰²ç¼–ç æ‹¾å–ç®—æ³•

ä¼ ç»Ÿå›¾å½¢æ‹¾å–éœ€è¦éå†æ‰€æœ‰å®ä½“åšè¾¹ç•Œæ£€æµ‹ï¼Œæ—¶é—´å¤æ‚åº¦ O(n)ã€‚æœ¬å¼•æ“ä½¿ç”¨é¢œè‰²ç¼–ç å®ç° O(1) æ‹¾å–ï¼š

**ç®—æ³•å®ç°ï¼š**

```typescript
class Entity {
  // ID ç¼–ç ä¸º RGB é¢œè‰²
  idToRGBA(id: number): [r, g, b, a] {
    if (id > 0xffffff) throw new Error('ID exceeds 24-bit limit')
    
    const r = (id >> 16) & 0xff  // é«˜ 8 ä½
    const g = (id >> 8) & 0xff   // ä¸­ 8 ä½
    const b = id & 0xff          // ä½ 8 ä½
    const a = 255
    
    return [r, g, b, a]
  }
  
  // RGB é¢œè‰²è§£ç ä¸º ID
  rgbaToId([r, g, b, a]: number[]): string {
    if (a === 0) return '0'  // é€æ˜ = èƒŒæ™¯
    const id = (r << 16) | (g << 8) | b
    return String(id)
  }
}
```

**æ€§èƒ½å¯¹æ¯”ï¼š**

| å®ä½“æ•°é‡ | ä¼ ç»Ÿè¾¹ç•Œæ£€æµ‹ | é¢œè‰²ç¼–ç  | æ€§èƒ½æå‡ |
|---------|------------|---------|---------|
| 100 | ~5ms | ~0.1ms | **50x** |
| 1000 | ~50ms | ~0.1ms | **500x** |
| 10000 | ~500ms | ~0.1ms | **5000x** |

**å¯è§†åŒ–åŸç†ï¼š**

```mermaid
graph LR
    A[ç‚¹å‡»åæ ‡ x,y] --> B[è¯»å–ç¦»å±Canvas<br/>åƒç´  getImageData]
    B --> C{RGBA å€¼}
    C -->|255,0,0,255| D[ID = 16711680]
    C -->|0,255,0,255| E[ID = 65280]
    C -->|0,0,255,255| F[ID = 255]
    C -->|0,0,0,0| G[èƒŒæ™¯ æ— å®ä½“]
    
    D --> H[è¿”å›å®ä½“å¯¹è±¡]
    E --> H
    F --> H
    G --> I[è¿”å› null]
    
    style B fill:#3498db,color:#fff
    style H fill:#2ecc71,color:#fff
```

### 3. ç¦»å±æ¸²æŸ“ç¼“å­˜

PickingSystem ç»´æŠ¤ç‹¬ç«‹çš„ç¦»å± Canvasï¼Œåªåœ¨å®ä½“å˜åŒ–æ—¶æ›´æ–°ï¼š

```typescript
class PickingSystem extends System {
  private needsUpdate = true
  
  update(stateStore: StateStore) {
    if (!this.needsUpdate) return  // è·³è¿‡é‡å¤æ¸²æŸ“
    
    this.render(stateStore)
    this.needsUpdate = false
  }
  
  // å®ä½“å˜åŒ–æ—¶æ ‡è®°
  markDirty() {
    this.needsUpdate = true
  }
}
```

### 4. è§†å£è£å‰ªä¼˜åŒ–

åªæ¸²æŸ“å¯è§åŒºåŸŸå†…çš„å®ä½“ï¼š

```typescript
class RenderSystem extends System {
  async render(stateStore: StateStore) {
    const viewport = this.calculateViewport()
    
    for (const [entityId, pos] of stateStore.position) {
      // è§†å£è£å‰ª
      if (!this.isInViewport(pos, viewport)) continue
      
      await this.drawShape(stateStore, entityId)
    }
  }
  
  private isInViewport(pos: Position, viewport: Box): boolean {
    const size = this.engine.stateStore.size.get(entityId)
    return !(
      pos.x + size.width < viewport.left ||
      pos.x > viewport.right ||
      pos.y + size.height < viewport.top ||
      pos.y > viewport.bottom
    )
  }
}
```

### 5. ECS å†…å­˜å¸ƒå±€ä¼˜åŒ–

ç»„ä»¶æŒ‰ç±»å‹èšåˆå­˜å‚¨ï¼Œæé«˜ CPU ç¼“å­˜å‘½ä¸­ç‡ï¼š

```typescript
// âŒ ä¼ ç»Ÿ AoS (Array of Structures)
class GameObject {
  x: number
  y: number
  width: number
  height: number
  color: string
  rotation: number
  // ... æ›´å¤šå±æ€§
}
const objects: GameObject[] = []

// âœ… ECS SoA (Structure of Arrays)
interface StateStore {
  position: Map<ID, { x, y }>       // ä½ç½®æ•°æ®èšåˆ
  size: Map<ID, { width, height }>  // å°ºå¯¸æ•°æ®èšåˆ
  color: Map<ID, { fill, stroke }>  // é¢œè‰²æ•°æ®èšåˆ
  // ...
}
```

**å†…å­˜è®¿é—®æ¨¡å¼å¯¹æ¯”ï¼š**

```mermaid
graph TB
    subgraph "AoS - è·³è·ƒè®¿é—®"
        A1[Obj1: x,y,w,h,color...]
        A2[Obj2: x,y,w,h,color...]
        A3[Obj3: x,y,w,h,color...]
        A4[éå†ä½ç½®éœ€è¦è·³è¿‡<br/>å¤§é‡æ— å…³æ•°æ®]
    end
    
    subgraph "SoA - è¿ç»­è®¿é—®"
        B1[Position: x1,y1,x2,y2,x3,y3]
        B2[Size: w1,h1,w2,h2,w3,h3]
        B3[Color: c1,c2,c3]
        B4[éå†ä½ç½®åªè¯»å–<br/>è¿ç»­å†…å­˜å—]
    end
    
    style B1 fill:#2ecc71,color:#fff
    style B4 fill:#f39c12
```

### 6. åŒå¼•æ“æ€§èƒ½è°ƒåº¦

æ ¹æ®åœºæ™¯å¤æ‚åº¦è‡ªåŠ¨åˆ‡æ¢æ¸²æŸ“å¼•æ“ï¼š

```typescript
class PerformanceMonitor {
  private fps = 60
  
  monitor(engine: Engine) {
    const entityCount = engine.stateStore.position.size
    
    if (entityCount > 1000 && engine.rendererManager.rendererName === 'Canvas2D') {
      console.warn('å®ä½“è¿‡å¤šï¼Œå»ºè®®åˆ‡æ¢åˆ° CanvasKit')
      engine.rendererManager.setRenderer('Canvaskit')
    }
    
    if (this.fps < 30) {
      console.warn('æ€§èƒ½ä¸è¶³ï¼Œé™ä½æ¸²æŸ“è´¨é‡')
      this.enablePerformanceMode()
    }
  }
  
  private enablePerformanceMode() {
    // ç¦ç”¨æŠ—é”¯é½¿
    // é™ä½æ¸²æŸ“ç²¾åº¦
    // å‡å°‘ç‰¹æ•ˆ
  }
}
```

### 7. Web Worker å¹¶è¡Œè®¡ç®—

å°†å¤æ‚è®¡ç®—ç§»åˆ° Worker çº¿ç¨‹ï¼š

```typescript
// main.ts
const worker = new Worker('geometry.worker.ts')

worker.postMessage({
  type: 'calculatePath',
  points: largePointsArray
})

worker.onmessage = (e) => {
  const path = e.data.path
  this.renderPath(path)
}

// geometry.worker.ts
self.onmessage = (e) => {
  if (e.data.type === 'calculatePath') {
    const result = expensiveCalculation(e.data.points)
    self.postMessage({ path: result })
  }
}
```

### 8. å¯¹è±¡æ± å¤ç”¨

é¿å…é¢‘ç¹åˆ›å»ºé”€æ¯å¯¹è±¡ï¼š

```typescript
class ObjectPool<T> {
  private pool: T[] = []
  
  constructor(private factory: () => T) {}
  
  acquire(): T {
    return this.pool.pop() || this.factory()
  }
  
  release(obj: T) {
    this.pool.push(obj)
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const paintPool = new ObjectPool(() => new ck.Paint())

function render() {
  const paint = paintPool.acquire()
  // ä½¿ç”¨ paint ç»˜åˆ¶
  paintPool.release(paint)
}
```

### 9. äº‹ä»¶å§”æ‰˜

åœ¨å®¹å™¨å±‚çº§ç›‘å¬äº‹ä»¶ï¼Œé¿å…ä¸ºæ¯ä¸ªå®ä½“ç»‘å®šç›‘å¬å™¨ï¼š

```typescript
class InputSystem extends System {
  constructor(engine: Engine) {
    super()
    
    // âœ… åªåœ¨ canvas ä¸Šç›‘å¬ä¸€æ¬¡
    engine.canvasDom.addEventListener('click', this.onClick.bind(this))
    engine.canvasDom.addEventListener('mousemove', this.onMouseMove.bind(this))
  }
  
  onClick(e: MouseEvent) {
    const entityId = this.pickEntity(e.clientX, e.clientY)
    // äº‹ä»¶åˆ†å‘ç»™å¯¹åº”å®ä½“
  }
}
```

### æ€§èƒ½åŸºå‡†æµ‹è¯•

```typescript
class FpsSystem extends System {
  private frames: number[] = []
  private lastTime = performance.now()
  
  update(stateStore: StateStore) {
    const now = performance.now()
    const delta = now - this.lastTime
    this.lastTime = now
    
    const fps = 1000 / delta
    this.frames.push(fps)
    
    if (this.frames.length > 60) {
      const avgFps = this.frames.reduce((a, b) => a + b) / this.frames.length
      console.log(`å¹³å‡ FPS: ${avgFps.toFixed(2)}`)
      this.frames = []
    }
  }
}
```

**æ€§èƒ½æŒ‡æ ‡ï¼š**

| åœºæ™¯ | å®ä½“æ•°é‡ | Canvas2D FPS | CanvasKit FPS |
|-----|---------|--------------|---------------|
| ç®€å•çŸ©å½¢ | 100 | 60 | 60 |
| ç®€å•çŸ©å½¢ | 1000 | 45 | 60 |
| ç®€å•çŸ©å½¢ | 5000 | 20 | 55 |
| å¤æ‚è·¯å¾„ | 100 | 50 | 60 |
| å¤æ‚è·¯å¾„ | 1000 | 15 | 58 |

---

## DSL é…ç½®ç³»ç»Ÿ

---

## DSL é…ç½®ç³»ç»Ÿ

### è®¾è®¡ç›®æ ‡

DSLï¼ˆDomain Specific Languageï¼‰æ¨¡å—çš„ç›®æ ‡æ˜¯å°†å›¾å½¢åœºæ™¯åºåˆ—åŒ–ä¸º JSON æ ¼å¼ï¼Œå®ç°ï¼š

1. **åœºæ™¯æŒä¹…åŒ–** - ä¿å­˜åˆ°æ•°æ®åº“æˆ–æœ¬åœ°å­˜å‚¨
2. **åœºæ™¯ä¼ è¾“** - å‰åç«¯æ•°æ®äº¤æ¢
3. **åœºæ™¯å¿«ç…§** - æ’¤é”€/é‡åšåŠŸèƒ½çš„åŸºç¡€
4. **æ¨¡æ¿å¤ç”¨** - åˆ›å»ºå¯å¤ç”¨çš„å›¾å½¢æ¨¡æ¿

### é…ç½®ç»“æ„

```typescript
interface DSLParams {
  type: 'rect' | 'ellipse' | 'text' | 'img' | 'polygon'
  id?: string
  position: { x: number; y: number }
  size?: { width: number; height: number }
  color?: { fill: string; stroke: string }
  rotation?: { value: number }
  scale?: { value: number }
  zIndex?: { value: number }
  selected?: { isSelected: boolean }
  // å½¢çŠ¶ç‰¹å®šå±æ€§
  font?: { family: string; size: number; weight: string }
  radius?: { value: number }
  polygon?: { points: Point[] }
}
```

### DSL è§£æå™¨

```typescript
class DSL {
  constructor(params: DSLParams) {
    this.type = params.type
    this.id = params.id || this.generateId()
    this.position = new Position(params.position)
    this.size = params.size ? new Size(params.size) : new Size()
    this.color = params.color ? new Color(params.color) : new Color()
    // ... åˆå§‹åŒ–å…¶ä»–ç»„ä»¶
  }
  
  // è½¬æ¢ä¸ºçº¯æ•°æ®å¯¹è±¡
  toJSON(): DSLParams {
    return {
      type: this.type,
      id: this.id,
      position: { x: this.position.x, y: this.position.y },
      size: { width: this.size.width, height: this.size.height },
      color: { fill: this.color.fill, stroke: this.color.stroke },
      // ...
    }
  }
}
```

### åœºæ™¯åºåˆ—åŒ–

```typescript
class Core {
  // å¯¼å‡ºåœºæ™¯
  exportScene(): string {
    const scene = {
      version: '1.0',
      entities: Array.from(this.stateStore.position.keys()).map(id => {
        return {
          id,
          type: this.stateStore.type.get(id),
          position: this.stateStore.position.get(id),
          size: this.stateStore.size.get(id),
          color: this.stateStore.color.get(id),
          // ... å…¶ä»–ç»„ä»¶
        }
      })
    }
    
    return JSON.stringify(scene, null, 2)
  }
  
  // å¯¼å…¥åœºæ™¯
  importScene(json: string) {
    const scene = JSON.parse(json)
    const dsls = scene.entities.map((e: any) => new DSL(e))
    this.engine.initComponents(dsls)
  }
}
```

### é…ç½®ç¤ºä¾‹

```json
{
  "version": "1.0",
  "entities": [
    {
      "type": "rect",
      "id": "001001001",
      "position": { "x": 100, "y": 100 },
      "size": { "width": 200, "height": 150 },
      "color": {
        "fill": "#4A90E2",
        "stroke": "#2E5C8A"
      },
      "rotation": { "value": 0 },
      "zIndex": { "value": 1 }
    },
    {
      "type": "text",
      "id": "002002002",
      "position": { "x": 150, "y": 300 },
      "font": {
        "family": "Arial",
        "size": 24,
        "weight": "bold"
      },
      "color": { "fill": "#333333" }
    }
  ]
}
```

---

## ç›¸æœºç³»ç»Ÿ

### åŠŸèƒ½è®¾è®¡

Camera ç±»ç®¡ç†ç”»å¸ƒçš„è§†å£å˜æ¢ï¼Œå®ç°å¹³ç§»å’Œç¼©æ”¾ï¼š

```typescript
class Camera {
  translateX: number = 0
  translateY: number = 0
  zoom: number = 1
  
  // å¹³ç§»
  pan(deltaX: number, deltaY: number) {
    this.translateX += deltaX
    this.translateY += deltaY
  }
  
  // ç¼©æ”¾åˆ°æŒ‡å®šç‚¹
  zoomTo(scale: number, centerX: number, centerY: number) {
    const prevZoom = this.zoom
    this.zoom = scale
    
    // è°ƒæ•´å¹³ç§»ä»¥ä¿æŒä¸­å¿ƒç‚¹ä½ç½®
    this.translateX = centerX - (centerX - this.translateX) * (scale / prevZoom)
    this.translateY = centerY - (centerY - this.translateY) * (scale / prevZoom)
  }
  
  // é‡ç½®è§†å›¾
  reset() {
    this.translateX = 0
    this.translateY = 0
    this.zoom = 1
  }
}
```

### ç›¸æœºå˜æ¢ç¤ºæ„

```mermaid
graph TB
    A[ä¸–ç•Œåæ ‡ç³»<br/>å®ä½“ä½ç½®] --> B{ç›¸æœºå˜æ¢}
    
    B --> C[1. ç¼©æ”¾<br/>scale zoom]
    C --> D[2. å¹³ç§»<br/>translate x,y]
    D --> E[å±å¹•åæ ‡ç³»<br/>åƒç´ ä½ç½®]
    
    F[ç”¨æˆ·æ“ä½œ] --> G{æ“ä½œç±»å‹}
    G -->|æ»šè½®| H[ä¿®æ”¹ zoom]
    G -->|æ‹–æ‹½ç”»å¸ƒ| I[ä¿®æ”¹ translateX/Y]
    
    H --> B
    I --> B
    
    style A fill:#3498db,color:#fff
    style E fill:#2ecc71,color:#fff
```

### åæ ‡è½¬æ¢

```typescript
class Camera {
  // å±å¹•åæ ‡ -> ä¸–ç•Œåæ ‡
  screenToWorld(screenX: number, screenY: number): Point {
    return {
      x: (screenX - this.translateX) / this.zoom,
      y: (screenY - this.translateY) / this.zoom
    }
  }
  
  // ä¸–ç•Œåæ ‡ -> å±å¹•åæ ‡
  worldToScreen(worldX: number, worldY: number): Point {
    return {
      x: worldX * this.zoom + this.translateX,
      y: worldY * this.zoom + this.translateY
    }
  }
}
```

---

## ä½è€¦åˆæ¶æ„å®è·µ

### ä¾èµ–æ–¹å‘

æ•´ä¸ªå¼•æ“ä¸¥æ ¼éµå¾ªä¾èµ–å€’ç½®åŸåˆ™ï¼š

```mermaid
graph TB
    A[åº”ç”¨å±‚<br/>React ç»„ä»¶] --> B[å¼•æ“æ¥å£<br/>Engine API]
    B --> C[ç³»ç»Ÿå±‚<br/>System]
    C --> D[ç»„ä»¶å±‚<br/>Component]
    C --> E[å®ä½“å±‚<br/>Entity]
    
    F[æ¸²æŸ“å±‚<br/>Renderer] --> G[æ¸²æŸ“æ¥å£<br/>BaseRenderer]
    C --> G
    
    style B fill:#f39c12,color:#fff
    style G fill:#f39c12,color:#fff
```

**å…³é”®è®¾è®¡ï¼š**
- ä¸Šå±‚ä¾èµ–æ¥å£ï¼Œä¸ä¾èµ–å…·ä½“å®ç°
- System ä¸ç›´æ¥ä¾èµ– Rendererï¼Œé€šè¿‡ RendererManager è§£è€¦
- Component çº¯æ•°æ®ï¼Œé›¶ä¾èµ–

### æ¥å£éš”ç¦»

æ¯ä¸ªæ¨¡å—æš´éœ²æœ€å°æ¥å£ï¼š

```typescript
// âŒ æš´éœ²è¿‡å¤šç»†èŠ‚
class Engine {
  public stateStore: StateStore
  public SystemMap: Map<string, System>
  public rendererManager: RendererManager
  // å¤–éƒ¨å¯ä»¥ç›´æ¥ä¿®æ”¹å†…éƒ¨çŠ¶æ€
}

// âœ… æ¥å£éš”ç¦»
interface EngineContext {
  getStateStore(): Readonly<StateStore>
  addSystem(system: System): void
  getSystemByName<T>(name: string): T | undefined
  setRenderer(name: string): void
}

class Engine implements EngineContext {
  private stateStore: StateStore
  private SystemMap: Map<string, System>
  
  // åªæš´éœ²å¿…è¦æ–¹æ³•
  getStateStore() { return this.stateStore }
  addSystem(system: System) { /* ... */ }
  // ...
}
```

### äº‹ä»¶é©±åŠ¨è§£è€¦

ç³»ç»Ÿé—´é€šè¿‡äº‹ä»¶é€šä¿¡ï¼Œé¿å…ç›´æ¥è°ƒç”¨ï¼š

```typescript
class EventBus {
  private listeners = new Map<string, Function[]>()
  
  on(event: string, callback: Function) {
    if (!this.listeners.has(event)) {
      this.listeners.set(event, [])
    }
    this.listeners.get(event)!.push(callback)
  }
  
  emit(event: string, data: any) {
    this.listeners.get(event)?.forEach(cb => cb(data))
  }
}

// ä½¿ç”¨ç¤ºä¾‹
class DragSystem extends System {
  update() {
    if (this.isDragging) {
      // å‘å‡ºäº‹ä»¶è€Œéç›´æ¥è°ƒç”¨ RenderSystem
      this.eventBus.emit('entity:moved', {
        entityId: this.draggingId,
        position: this.newPosition
      })
    }
  }
}

class RenderSystem extends System {
  constructor() {
    // ç›‘å¬äº‹ä»¶
    this.eventBus.on('entity:moved', () => {
      this.markDirty()
    })
  }
}
```

---

## æ‰©å±•æ€§è®¾è®¡æ€»ç»“

### æ‰©å±•ç‚¹æ¸…å•

| æ‰©å±•ç±»å‹ | æ‰©å±•æ–¹å¼ | éš¾åº¦ | ç¤ºä¾‹ |
|---------|---------|------|------|
| **æ–°å¢å›¾å½¢ç±»å‹** | 1. åˆ›å»º Component<br/>2. å®ç° Renderer<br/>3. æ³¨å†Œåˆ° RendererManager | â­ï¸â­ï¸ | Star, Triangle, Arrow |
| **æ–°å¢äº¤äº’ç³»ç»Ÿ** | 1. ç»§æ‰¿ System<br/>2. å®ç° update()<br/>3. addSystem() | â­ï¸â­ï¸ | UndoRedo, Snapping |
| **åˆ‡æ¢æ¸²æŸ“åç«¯** | 1. å®ç° BaseRenderer æ¥å£<br/>2. æ³¨å†Œåˆ° RendererManager | â­ï¸â­ï¸â­ï¸ | SVG, WebGL, WebGPU |
| **è‡ªå®šä¹‰ç»„ä»¶** | 1. åˆ›å»º Component ç±»<br/>2. æ·»åŠ åˆ° StateStore | â­ï¸ | Opacity, Shadow |
| **æ’ä»¶ç³»ç»Ÿ** | ä½¿ç”¨ System ä½œä¸ºæ’ä»¶è½½ä½“ | â­ï¸ | Plugin.init(engine) |

### å®é™…æ‰©å±•æ¡ˆä¾‹

#### æ¡ˆä¾‹ 1ï¼šæ·»åŠ ä¸‰è§’å½¢å›¾å½¢

```typescript
// 1. åˆ›å»ºç»„ä»¶ï¼ˆä½¿ç”¨å·²æœ‰çš„ Polygon ç»„ä»¶ï¼‰
// 2. å®ç°æ¸²æŸ“å™¨
class TriangleRender extends BaseRenderer {
  draw(entityId: string) {
    const polygon = this.getComponent<Polygon>(entityId, 'polygon')
    const color = this.getComponent<Color>(entityId, 'color')
    
    const ctx = this.engine.ctx
    ctx.beginPath()
    ctx.moveTo(polygon.points[0].x, polygon.points[0].y)
    ctx.lineTo(polygon.points[1].x, polygon.points[1].y)
    ctx.lineTo(polygon.points[2].x, polygon.points[2].y)
    ctx.closePath()
    ctx.fillStyle = color.fill
    ctx.fill()
  }
}

// 3. æ³¨å†Œ
engine.rendererManager.renderer.triangle = TriangleRender
```

#### æ¡ˆä¾‹ 2ï¼šæ·»åŠ é˜´å½±æ•ˆæœ

```typescript
// 1. åˆ›å»ºç»„ä»¶
class Shadow {
  constructor(
    public offsetX: number = 0,
    public offsetY: number = 0,
    public blur: number = 0,
    public color: string = '#000000'
  ) {}
}

// 2. æ·»åŠ åˆ° StateStore
interface StateStore {
  // ... å·²æœ‰ç»„ä»¶
  shadow: Map<EntityId, Shadow>
}

// 3. ä¿®æ”¹æ¸²æŸ“å™¨æ”¯æŒé˜´å½±
class RectRender extends BaseRenderer {
  draw(entityId: string) {
    const shadow = this.getComponent<Shadow>(entityId, 'shadow')
    
    if (shadow) {
      this.engine.ctx.shadowOffsetX = shadow.offsetX
      this.engine.ctx.shadowOffsetY = shadow.offsetY
      this.engine.ctx.shadowBlur = shadow.blur
      this.engine.ctx.shadowColor = shadow.color
    }
    
    // åŸæœ‰æ¸²æŸ“é€»è¾‘...
  }
}
```

---

## æ€»ç»“

Duck-Core å‰ç«¯æ¸²æŸ“å¼•æ“é€šè¿‡ä»¥ä¸‹è®¾è®¡å®ç°äº†é«˜æ€§èƒ½ã€é«˜æ‰©å±•æ€§ï¼š

### æ ¸å¿ƒä¼˜åŠ¿

1. **ECS æ¶æ„** - æ•°æ®ä¸é€»è¾‘å®Œå…¨åˆ†ç¦»ï¼Œç»„ä»¶è‡ªç”±ç»„åˆ
2. **åŒå¼•æ“æ¶æ„** - Canvas2D ä¸ CanvasKit å¯çƒ­åˆ‡æ¢ï¼Œå…¼é¡¾å…¼å®¹æ€§ä¸æ€§èƒ½
3. **æ’ä»¶åŒ–ç³»ç»Ÿ** - æ‰€æœ‰åŠŸèƒ½ä»¥ System å½¢å¼å®ç°ï¼ŒæŒ‰éœ€åŠ è½½
4. **é¢œè‰²ç¼–ç æ‹¾å–** - O(1) æ—¶é—´å¤æ‚åº¦ï¼Œæ”¯æŒä»»æ„å¤æ‚å›¾å½¢
5. **ä½è€¦åˆè®¾è®¡** - æ¥å£éš”ç¦»ã€ä¾èµ–å€’ç½®ã€äº‹ä»¶é©±åŠ¨
6. **æè‡´æ€§èƒ½** - æ¸²æŸ“èŠ‚æµã€ç¦»å±ç¼“å­˜ã€è§†å£è£å‰ªã€å†…å­˜ä¼˜åŒ–

### æŠ€æœ¯æŒ‡æ ‡

- æ”¯æŒ 10,000+ å®ä½“æµç•…æ¸²æŸ“ï¼ˆCanvasKit æ¨¡å¼ï¼‰
- å›¾å½¢æ‹¾å–å»¶è¿Ÿ < 1ms
- æ¸²æŸ“å¸§ç‡ç¨³å®š 60 FPS
- å¼•æ“åŒ…ä½“ç§¯ < 50KBï¼ˆä¸å« CanvasKitï¼‰
- æ”¯æŒè¿è¡Œæ—¶çƒ­åˆ‡æ¢æ¸²æŸ“åç«¯

### é€‚ç”¨åœºæ™¯

âœ… åœ¨çº¿è®¾è®¡å·¥å…·ï¼ˆå¦‚ Figmaã€Canvaï¼‰  
âœ… æ•°æ®å¯è§†åŒ–å¤§å±  
âœ… æµç¨‹å›¾ç¼–è¾‘å™¨  
âœ… ç™½æ¿åä½œå·¥å…·  
âœ… æ¸¸æˆå…³å¡ç¼–è¾‘å™¨  

è¿™å¥—æ¶æ„ä¸ºå¤æ‚å›¾å½¢åº”ç”¨æä¾›äº†åšå®çš„æŠ€æœ¯åŸºç¡€ï¼ŒåŒæ—¶ä¿æŒäº†è¶³å¤Ÿçš„çµæ´»æ€§ä»¥åº”å¯¹æœªæ¥çš„éœ€æ±‚å˜åŒ–ã€‚


